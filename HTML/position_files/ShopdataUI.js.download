//  jQuery Cache
var $CACHE_DATA = {};
function $CACHE(selector)
{
    // $CACHE: jQuery return object cacher
    // this is a transparent layer over jquery which only requires << var $CACHE_DATA = {}; >> in some outside context
    //      selector: string, jquery selector
    var obj = {};

    // Don't cache until DOM loaded -- Disabled
    // if(!g_RUN) return $(selector);

    if(typeof $CACHE_DATA[selector] !== 'undefined')
    {
        obj = $CACHE_DATA[selector];
    }
    else
    {
        obj = $(selector);
        $CACHE_DATA[selector] = obj;
    }
    return obj;
}

// Copy Object
function deepCopy(o)
{
    var copy = o,k;

    if (o && typeof o === 'object') {
        copy = Object.prototype.toString.call(o) === '[object Array]' ? [] : {};
        for (k in o) {
            copy[k] = deepCopy(o[k]);
        }
    }

    return copy;
}

// Shop Data User Interface
var ShopdataUI =
{
    SDADULTDTA_HTML: '<option value="">(Select Type)</option>',
    SDCHILDDTA_HTML: '<option value="">(Select Type)</option>',

    baseURL: '',
    values: {},
    storePhonePrefix: '',
    SDCARTSTR: '',
    SDEMPNUM: '',
    SDCARTHFC: '',
    valuesData: {},
    clickEventToUse: 'click',
    isManager: false,
    isCartReadOnly: false,
    activeCustomerTab: 0,

    loginState: 0,
    loginJQXHR: null,
    customers: [],
    loginCustomer: null,
    lookupSameCustomer: false,
    data: {},
    dft: {},
    customerLookup: {},
    delInst: {},
    firstRequired: '',
    tabError: '',
    zipValid: true,
    isLookup: false,
    useFreshAddressClientSide: false,
    addressSearchWaitTime: 500,
    sync_customer: false,
    timeOutSetter: null,

    status: '',

    dataUI:
    {
        SDMKTGDTA: [],
        SDDEPTLIKE: [],
        SDDEPTSHOP: [],
        SDCOMPSHOP: [],
        SDCOMPNEXT: []
    },

    pdzS: function(n,len)
    {
        // Padded zero string
        if(n == null) n = '';
        if(typeof(len) === 'undefined') len = 2;
        var nStr = n.toString();
        var n0 = len - nStr.length;
        if(n0 > 0) nStr = new Array(n0 + 1).join('0') + nStr;
        return nStr;
    },

    loader: function(baseURL, loadData, valuesData, SDCARTSTR, SDEMPNUM, SDCARTHFC, StorePhonePrefix, clickeventtouse, isManager, useFreshAddressClientSide)
    {
        var key, tmpHtml, buttonHtml, valueHtml, valueIdx;
        window.$CACHE_DATA = {};
        ShopdataUI.baseURL = baseURL;
        ShopdataUI.values = valuesData;
        ShopdataUI.storePhonePrefix = StorePhonePrefix;
        ShopdataUI.valuesData = valuesData;
        // Set data header
        ShopdataUI.SDCARTSTR = ShopdataUI.pdzS(SDCARTSTR, 3);
        ShopdataUI.SDEMPNUM  = ShopdataUI.pdzS(SDEMPNUM, 5);
        ShopdataUI.SDCARTHFC = ShopdataUI.pdzS(SDCARTHFC, 2);

        if(arguments.length==7 && arguments[6]!=null && arguments[6].trim().length>0){
            ShopdataUI.clickEventToUse=arguments[6];
        }

        if(arguments.length==8 && arguments[7]!=null && arguments[7].trim().length>0){
            ShopdataUI.isManager = (arguments[7]=='true'?true:false);
        }

        if(arguments.length==9 && arguments[8]!=null && arguments[8].trim().length>0){
        	ShopdataUI.useFreshAddressClientSide = (arguments[8]=='true'?true:false);
        }

        // Load UI
        for(key in valuesData)
        {
            if(valuesData.hasOwnProperty(key))
            {
                // Construct HTML
                valueHtml = '';

                $.each(valuesData[key], function( index, value ) {
                	//alert( index + ": " + value );

                	tmpHtml = '<option value="'+ index +'">'+ value +'</option>';

                    buttonHtml = '<div data-button="Data" class="button '+key+'"'
                               + ' id="'+key+'_'+index.toString()+'">'
                               + value
                               + '</div>';

                    switch(key)
                    {
                        case 'SDADULTDTA': ShopdataUI.SDADULTDTA_HTML += tmpHtml; break;
                        case 'SDCHILDDTA': ShopdataUI.SDCHILDDTA_HTML += tmpHtml; break;
                        case 'SDMKTGDTA' : valueHtml += tmpHtml; break;
                        case 'SDDEPTLIKE': valueHtml += tmpHtml; break;
                        case 'SDDEPTSHOP': valueHtml += tmpHtml; break;
                        case 'SDCOMPSHOP': valueHtml += tmpHtml; break;
                        case 'SDCOMPNEXT': valueHtml += tmpHtml; break;
                        case 'SDEXITTYPE': valueHtml += tmpHtml; break;
                        default:           valueHtml += buttonHtml; break;
                    }


            	});

                // Render
                if(key !== 'SDADULTDTA' && key !== 'SDCHILDDTA')
                {
                    $('#'+key).html(valueHtml);
                    $('#L'+key).html(valueHtml);
                }
            }
        }
        var options = ["CUSTMINCN","CUSTPCNT","CUSTGATE","CUSTFLOOR","CUSTELEV"];
        for(i = 0; i < options.length; i++)
        {
			var valueHtml = '';
			var selected = valuesData[options[i]].DFT;
			ShopdataUI.dft[options[i]] = selected;
			$.each( valuesData[options[i]], function( key, value ) {
				if (key!="DFT") {
                    if(key == selected) {
                        valueHtml += '<option selected value="'+key+'">'+value+'</option>';
                    } else {
                        valueHtml += '<option value="'+key+'">'+value+'</option>';
                    }
                }
			});
            $('#'+options[i]).html(valueHtml).val(selected);
			if (options[i]=="CUSTMINCN"){
				var opt = $("#CUSTMINCN option").sort(function (a,b) { return a.value.toUpperCase().localeCompare(b.value.toUpperCase()) });
				$("#CUSTMINCN").append(opt);
			}
        }

        ShopdataUI.PopulatePUStoresList();

        // Set Datepicker language
        $.datepicker.regional['en-GB'] = {
				closeText: 'Done',
				prevText: 'Prev',
				nextText: 'Next',
				currentText: 'Today',
				monthNames: ['January','February','March','April','May','June',
				'July','August','September','October','November','December'],
				monthNamesShort: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
				'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
				dayNames: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
				dayNamesShort: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
				dayNamesMin: ['Su','Mo','Tu','We','Th','Fr','Sa'],
				weekHeader: 'Wk',
				dateFormat: 'mm/dd/yy',
				firstDay: 1,
				isRTL: false,
				showMonthAfterYear: false,
				yearSuffix: ''
        };
        $.datepicker.setDefaults($.datepicker.regional['en-GB']);

        // Start UI
        $('body')
            .on(ShopdataUI.clickEventToUse,'#cmdExitCustomer, #btnDisengage', ShopdataUI.ExitCustomer)
            .on(ShopdataUI.clickEventToUse,'.ShopdataModalClose',function(event){ShopdataUI.Modal_Close(event.target)})
            .on(ShopdataUI.clickEventToUse,'#cmdEngage, .options-engage',  ShopdataUI.Engage)
            .on(ShopdataUI.clickEventToUse,'#cmdLogout, #menuLogout',  ShopdataUI.cmdLogout)
            .on(ShopdataUI.clickEventToUse,'#cmdExitFloor, .options-exit',  ShopdataUI.ExitFloor)
			.on('keydown', '#txtSKU, #txtWord, #txtSKU2, #txtWord2', ShopdataUI.validateSearch)
            .on(ShopdataUI.clickEventToUse,'#LoginWindowWelcomeCancel, #LoginWindowCustomerCancel, #LoginWindowNotFoundCancel', ShopdataUI.lookUpCustomer)
            .on(ShopdataUI.clickEventToUse,'#ProductWindow_PurePromise', ShopdataUI.openPurePromisePDF)
            .on(ShopdataUI.clickEventToUse,'.numberOfVisitors', ShopdataUI.cmdCustomerSize)
        	.on('click', '.saveCustomerInfo', ShopdataUI.saveCustomerInfo)
        	.on(ShopdataUI.clickEventToUse,'#closeSaveDelInst', ShopdataUI.saveDelInst)
        	.on(ShopdataUI.clickEventToUse,'.closeCustomerInfoWindow ', ShopdataUI.checkForChangeCustomerInfo)
            .on(ShopdataUI.clickEventToUse,'#checklist', ShopdataUI.openCustomerChecklist)
            .on('change','#managerItems', ShopdataUI.managerItems)
            .on(ShopdataUI.clickEventToUse,'.selection', ShopdataUI.checkSelection)            
            .on(ShopdataUI.clickEventToUse,'.check-parent', ShopdataUI.checkAll)            
            .on(ShopdataUI.clickEventToUse,'.signature-reset', ShopdataUI.clearSignature)
            .on(ShopdataUI.clickEventToUse,'.arm-facing', ShopdataUI.setFurnitureSide)
            .on(ShopdataUI.clickEventToUse,'.closeCustomerChecklist', ShopdataUI.closeCustomerChecklist)
            .on(ShopdataUI.clickEventToUse,'.saveCustomerChecklist', ShopdataUI.saveCustomerChecklist)
        	.on(ShopdataUI.clickEventToUse,'.closeCustomerLookup',function (){ShopdataUI.customerLookup={};})
        	.on('focusout', '#SDCUSZIP, #SCSHPZIP', ShopdataUI.countZipCharacters)
        	.on('keydown keypress','#LSDCUSPHON1, #LSDCUSEMAIL',ShopdataUI.CustomerInfoLookup_KeyboardEnter)
        	.on('change','#TXTPUSTORE', ShopdataUI.changePUStore)
            .on(ShopdataUI.clickEventToUse, '.configGuide', ShopdataUI.viewConfigurationGuide);



		$(".numberinput").forceNumeric();

        $('#shopdataScreen').on('keypress','input',  ShopdataUI.Inkey);
        $('#SCDSCCODE').bind('propertychange keyup input paste', ShopdataUI.formatDiscountCode);
        $('#SCDSCCODE').on( "blur", ShopdataUI.discountCart);
        $('#CUSTPCNT').on( "change", ShopdataUI.showNote);
        $('body').delegate('#SDCUSPHON1, #SDCUSPHON2, #SCSHPPHON1, #SCSHPPHON2', "blur", ShopdataUI.checkPhoneType);
        $('#LoginWindowEasyPass').on( "blur", ShopdataUI.checkIfValidEasyPass);
        $('#LoginWindowEasyPass').bind('propertychange keyup input paste',function (){$('#LoginWindowEasyPassValid').html('');});
        $('#SDCUSLNAME,#SDCUSEMAIL,#SDCUSZIP,#SDCUSCITY,#SDCUSPHON1,#SDCUSPTYP1,#SCSHPLNAME,#SCSHPEMAIL,#SCSHPZIP,#SCSHPCITY,#SCSHPPHON1,#SCSHPPTYP1').on("blur",
        	function (){
        		var fieldname = $(this)[0].id;
        		if ($('#'+fieldname).val()!==''){
        			$('#'+fieldname+'_Required').hide();
        			$('#'+fieldname).removeClass('profileRequired');
    			}
        	}
        );

        ShopdataUI.closingCustomerLookupWindow();
        ShopdataUI.changeTabPanel();
        ShopdataUI.showDatePicker();
        ShopdataUI.lookUpCustomer();
        ShopdataUI.closeCustomerInfoPage();
        ShopdataUI.closeManagerChecklist();
        ShopdataUI.closeManagerOtb();
        ShopdataUI.closeManagerRebates();
        ShopdataUI.closeManagerConnect();
        ShopdataUI.filterChecklists();
        ShopdataUI.filterCompliance();
        ShopdataUI.filterOtbCustomers();
        ShopdataUI.filterRebates();
        ShopdataUI.loadRelatedSKUDates();
        ShopdataUI.enterCustomerEmail();
        ShopdataUI.finance();
        ShopdataUI.doFinance();
		ShopdataUI.doProgressive();
        ShopdataUI.purePromiseRebate();
        ShopdataUI.whatIfCalculator();
        ShopdataUI.rebateDetails();
        ShopdataUI.contactRebate();
        ShopdataUI.doRebateContacted();
        ShopdataUI.assignRebate();
        ShopdataUI.doAssignRebate();
        ShopdataUI.rebateSummary();
        ShopdataUI.selectHFCRebates();

        $('body').delegate('#SDCUSPHON1, #SDCUSPHON2, #SCSHPPHON1, #SCSHPPHON2', 'propertychange keyup input paste', ShopdataUI.changePhoneType);
        $('#closeShopData, #closeShopData2').prop('disabled',ShopdataUI.isManager);
        $('body').delegate('#SDCUSFNAME, #SCSHPFNAME', "focus", ShopdataUI.clearFirstName);
        $('body').delegate("#SDCUSLNAME, #SCSHPLNAME", "focus", ShopdataUI.clearLastName);

        $('#refreshPage').click(function(event) {
            event.preventDefault();
            $('#redirectNotify').show();
            shopCartUI.CloseSideMenu();
            window.location.reload();
        });
        $('#menuLogouts').click(function(event) {
            event.preventDefault();
            shopCartUI.CloseSideMenu();
            shopCartUI.logOut();
        });

        ShopdataUI.DataListSupport();
        ShopdataUI.scrollToOpenCustomer();
        ShopdataUI.initCustomersList();
        ShopdataUI.customerLookupSelectCustomer();
        ShopdataUI.Customer_Select();
        ShopdataUI.newCustomerSelected();
        ShopdataUI.customerAddressLookup();
        ShopdataUI.customerAddressLookupSelection();
        ShopdataUI.checkForCustomerRecordLock();
        ShopdataUI.switchActiveCustomerTab();
        ShopdataUI.saveCustomerEmail();
        ShopdataUI.scheduleDateTimeWindow();
        ShopdataUI.saveScheduledDateTime();
        ShopdataUI.scheduleDateTimeMonthChange();
        ShopdataUI.viewFileManager();
        ShopdataUI.toggleDirectoryView();
        ShopdataUI.markFileAsRead();
        ShopdataUI.profileSettings();
        ShopdataUI.saveProfileSettings();
        ShopdataUI.generateNewLead();
        ShopdataUI.searchForDocument();
        ShopdataUI.fileManagerViewUnread();

        //ShopdataUI.showNotification();
        //setInterval(ShopdataUI.showNotification, 600000);

        $('#TXTDELZIP').keyup(ShopdataUI.countCharacters);

        var customer = $('#currentCustomerBox').data('customer');
        if(customer) {
            ShopdataUI.data = customer;
            if (ShopdataUI.data.CUSTPCNT == '' && ShopdataUI.data.SCDELDATE > 0 && ShopdataUI.data.CUSTNBR > 0 && ShopdataUI.data.SDCUSTNBR > 0) {
                shopCartUI.openDeliveryInstructions(true);
            }
        }
        ShopdataUI.setSelectedPUStore();
    },

    initCustomersList: function(){
    	var icons = {
        		header: "ui-icon-circle-arrow-e",
        		activeHeader: "ui-icon-circle-arrow-s"
		};
        $( "#inboxmenu" ).accordion({
        	collapsible: true,
        	heightStyle: "content",
        	icons: icons,
        	active: $('#inboxmenu').data('activeaccordion'),
        	autoHeight: true
        }).accordion( "refresh" );
        $(".ui-accordion .ui-accordion-header").css({
            "padding-top":"6px",
            "padding-bottom":"6px",
            "font-size": "18px"
        });
    },

    checkForCustomerRecordLock: function() {
        if($.isEmptyObject(ShopdataUI.data)) {
            var customerData = $('#currentCustomerBox').data('customer');
        } else {
            var customerData = ShopdataUI.data;
        }
        if(customerData) {
            var lockedStatuses = ['N', 'S', 'R', 'P', 'D'];
            if(lockedStatuses.indexOf(customerData.SDSTATCODE) !== -1) {
                ShopdataUI.isCartReadOnly = true;
                shopCartUI.displayMsg('Invoice cannot be maintained', 'Warning');
                return true;
            }
        }
        return false;
    },

    showDatePicker: function() {
        $('body').on('click', '#SDWANTDATE, #SDLASTDATE, #LSDWANTDATE, #LSDLASTDATE', function() {
            $(this).datepicker('show');
        })
    },

    switchActiveCustomerTab: function() {
        $('body').on('click', '#customerMenu li.disabled', function() {
             $('#shippingTab').trigger('click');
        });
    },

    initClearable: function() {
        $('.clearInput').remove();
        $('input.clearable, textarea.clearable').each(function() {
            if(typeof $(this).attr('type') != 'undefined') {
                $(this).after('<i class="fa fa-times-circle clearInput"></i>');
            } else {
                $(this).after('<i class="fa fa-times-circle clearInputTextArea"></i>');
            }
        });

        $('body').on('click', '.clearInput', function() {
            $(this).parent().find('input').val('');
            $(this).parent().find('textarea').val('');

            var customerFields = ['SDCUSFNAME', 'SDCUSMID', 'SDCUSLNAME', 'SDCUSEMAIL', 'SDCUSPHON1', 'SDCUSADDR1', 'SDCUSADDR2', 'SDCUSCITY', 'SDCUSSTATE', 'SDCUSZIP', 'SDCUSPTYP1'];
            var shippingFields = ['SCSHPFNAME', 'SCSHPMID', 'SCSHPLNAME', 'SCSHPEMAIL', 'SCSHPPHON1', 'SCSHPADDR1', 'SCSHPADDR2', 'SCSHPCITY', 'SCSHPSTATE', 'SCSHPZIP', 'SCSHPPTYP1'];
            if(ShopdataUI.sync_customer) {
                var customerId = $(this).prev().attr('id');
                var fieldPosition = customerFields.indexOf(customerId);
                if(fieldPosition >= 0) {
                    $('#'+shippingFields[fieldPosition]).val('');
                }
            }
        });
    },

    initMultiSelect: function() {
        $('.multiselect-box').multiselect({
            onChange: function(element, checked) {
                var selectId = element.parent().attr('id');
                if(selectId) {
                    var valueId = selectId.split('_');
                    valueId = valueId[0];

                    var selectedOptions = $('#'+selectId+' option:selected');
                    var selected = [];
                    $(selectedOptions).each(function(){
                        selected.push($(this).val());
                    });
                    selected = selected.join(";");
                    $('#'+valueId).val(selected);
                }
            }
        });
    },

    addCustomerInfoFromLookup: function() {
        $('#customerLookupWindow').modal('hide');
        $('#customerInfoArea').html('').addClass('hide');

        ShopdataUI.isLookup = false;
        ShopdataUI.data = $('#currentCustomerBox').attr('data-customer');
        if ($.isEmptyObject(ShopdataUI.data) || ShopdataUI.data == '')
        {
            ShopdataUI.customerLookUpData = ShopdataUI.customerLookup;
            $('.newCustomerDataSet').remove();
            ShopdataUI.openCustomerInfo = true;
            ShopdataUI.Engage();
        } else {
            if(ShopdataUI.lookupSameCustomer) {
                ShopdataUI.data.SDCUSEMAIL = ShopdataUI.data.SDCUSEMAIL == "" ? ShopdataUI.customerLookup.email : ShopdataUI.data.SDCUSEMAIL;
                ShopdataUI.data.SDCUSPHON1 = ShopdataUI.data.SDCUSPHON1 != "" || ShopdataUI.data.SDCUSPHON1 == 0 ? ShopdataUI.customerLookup.phone : ShopdataUI.data.SDCUSPHON1;
                $('#mainWindow').removeClass('hide');
                ShopdataUI.openCustomerInfoPage(false)
            } else {
                $.ajax({
                    url: ShopdataUI.baseURL+'index.php/main/exitCustomer',
                    success: function() {
                        ShopdataUI.data = {};
                        ShopdataUI.addCustomerInfoFromLookup();
                        ShopdataUI.lookupSameCustomer = false;
                    },
                    error: function(data) {
                        shopCartUI.handleCartError(data);
                    }
                });
            }
        }
    },

    formatDiscountCode: function(){
    	$('#SCDSCCODE').val($('#SCDSCCODE').val().toUpperCase());
    	$('#discountResponse').html('');
    },

    showNote: function(){
    	$('#CUSTPCNT_Note').toggle($('#CUSTPCNT').val()=='E');
    },

    clearFirstName: function(){
    	var val = $(this).val().trim().toUpperCase();
    	if (val.indexOf('AT ')==0) $(this).val('');
    },

    clearLastName: function(){
    	var val = $(this).val().trim().toUpperCase();
    	if (val=='CUSTOMER') $(this).val('');
    },

    changePhoneType: function(){
    	var phone = $(this).val().trim();
    	var cssselector = $(this)[0].id.replace('PHON','PTYP');
    	if (phone.length == 0){
	    	$('.'+cssselector).removeClass('buttonActive');
	    	$('#'+cssselector).val('');
	    }
    },

    checkPhoneType: function(){
    	var phonelen = $(this).val().trim().length;
		$('#'+$(this)[0].id+'_Required').toggle($(this).val().trim()!='' && $('#'+$(this)[0].id.replace('PHON','PTYP')).val().trim()=='');
		$('#'+$(this)[0].id+'_Invalid').toggle(phonelen!=14 && phonelen!=0);
    },

    customerLookupSelectCustomer: function() {
        $('body').on(shopCartUI.clickEventToUse, '#customerLookupWindow td', function() {
            $('#customerSearchSelect').prop('disabled', false);
            $('#customerLookupWindow tr').removeClass('active');
            $(this).closest('tr').addClass('active').find('input').prop('checked', true);
        });
    },

    openPurePromisePDF: function(){
        ShopdataUI.openPDFViewer('Pure Promise','PurePromise.pdf');
    },

    openPDFViewer: function(title, pdffile){
    	$('#LoginWindow').css({'display': 'visible'});
    	$('#PDFViewerTitle, #PDFFileContent').html('');
    	$('#PDFViewerTitle').html(title);
    	$('#PDFFileContent').html('<iframe src="' + ShopdataUI.baseURL + 'application/media/'+ pdffile +'" type="application/pdf"></iframe>');
        ShopdataUI.Modal_Open('#PDFViewer');
    },

    validateSearch: function(){
    	var curselector = $(this)[0].id;
    	if (curselector == 'txtSKU' || curselector == 'txtSKU2'){
    		$('#txtWord,#txtWord2').val('');
    	} else {
    		$('#txtSKU,#txtSKU2').val('');
    	}
    },

    CustomerInfoLookup_KeyboardEnter: function(e)
    {
        return true;
        // Assert Enter pressed
    	if (!e) e = window.event;
        var code = (e.keyCode) ? e.keyCode : e.which;
        if (code == 13 || code == 3)
        {
            // Click Go button
            ShopdataUI.lookUpCustomer();
            return false;
        }
        return true;
    },

    Loading_On: function()
    {
        $('#loadNotify').show();
    },

    Loading_Off: function()
    {
        $('#loadNotify').hide();
    },

    Inkey: function(e)
    {
        // Check for ENTER
    	event.stopImmediatePropagation();
        if(e.which == 13){
        	event.preventDefault();
            var $input = $('input');
            if($(this).is($input.last())){
                //Time to submit the form!!!!
            } else {
                $input.eq( $input.index( this ) + 1 ).focus();
            }
        }
    },

    destroyCustomerInfo: function() {
        $("#SDWANTDATE, #SDLASTDATE, #LSDWANTDATE, #LSDLASTDATE").datepicker("destroy");
        $('#CustomerInfo #shopdata').html('');
        $('.ui-multiselect-menu').remove();

        $('body').off('focusout', '#SDCUSEMAIL, #SDCUSPHON1, #SDCUSPHON2');
        $('body').off('click', '.primaryLabelInput');
        $('body').off('change', '#SDCUSFNAME, #SDCUSMID, #SDCUSLNAME, #SDCUSEMAIL, #SDCUSPHON1, #SDCUSPHON2, #SDCUSADDR1, #SDCUSADDR2, #SDCUSCITY, #SDCUSSTATE, #SDCUSZIP, #SDCUSTLAT, #SDCUSTLNG, #SDCUSPTYP1, #SDCUSPTYP2');
        $('body').off('change', '#SCSHPEMAIL, #SCSHPPHON1, #SCSHPPHON2, #SCSHPZIP, #SCSHPADDR1, #SCSHPCITY, #SCSHPSTATE, #SCSHPFNAME, #SCSHPLNAME');
        $('body').off(shopCartUI.clickEventToUse, '.SDCUSPTYP1, .SDCUSPTYP2, .SCSHPPTYP1, .SCSHPPTYP2');
        $('body').off('focusout', '#SDCUSPHON1, #SDCUSPHON2, #SCSHPPHON1, #SCSHPPHON2');
        $('body').off('click', '.customerOptInPhoneNumber');
        $('body').off('click', '#copyCustomerInfoToShipTo');

        ShopdataUI.lookupSameCustomer = true;
        ShopdataUI.customerLookup = {};
    },

    setPhoneTypeOnButtonClick: function() {
        $('body').on('click', '.SDCUSPTYP1, .SDCUSPTYP2, .SCSHPPTYP1, .SCSHPPTYP2', function () {
            var phoneType = $(this).data('value');
            $(this).closest('.col-md-9').find('input').val(phoneType);
            shopCartUI.textOptInMessenger($(this), 'type');
        });
    },

    watchForShippingAddressChanges: function() {
        $('#SCSHPZIP, #SCSHPADDR1, #SCSHPCITY, #SCSHPSTATE').change(function() {
            var shipZip     = $('#SCSHPZIP').val();
            var shipAddress = $('#SCSHPADDR1').val();
            var shipCity    = $('#SCSHPCITY').val();
            var shipState   = $('#SCSHPSTATE').val();

            var customerZip     = $('#SDCUSZIP').val();
            var customerAddress = $('#SDCUSADDR1').val();
            var customerCity    = $('#SDCUSCITY').val();
            var customerState   = $('#SDCUSSTATE').val();
            
            var requiredShipPreferred = false;

            if(shipZip.toUpperCase() != customerZip.toUpperCase()) {
                requiredShipPreferred = true;
            }
            if(shipAddress.toUpperCase() != customerAddress.toUpperCase()) {
                requiredShipPreferred = true;
            }
            if(shipCity.toUpperCase() != customerCity.toUpperCase()) {
                requiredShipPreferred = true;
            }
            if(shipState.toUpperCase() != customerState.toUpperCase()) {
                requiredShipPreferred = true;
            }
            setTimeout(function() { // had to add this due to the address lookup having a timer on it see ShopdataUI.customerAddressLookup();
                if(requiredShipPreferred == true) {
                    $('#shippingTab').attr('data-preferred', true);
                } else {
                    $('#shippingTab').attr('data-preferred', false);
                }
            }, 300);
        });

        var currentCustomer = $('#currentCustomerBox').attr('data-customer');
        if(currentCustomer) {
            currentCustomer = JSON.parse(currentCustomer);

            var setShipZip = currentCustomer.SCSHPZIP;
            var setShipAddress = currentCustomer.SCSHPADDR1;
            var setShipCity = currentCustomer.SCSHPCITY;
            var setShipState = currentCustomer.SCSHPSTATE;

            if(setShipAddress) {
                var customerZip     = $('#SDCUSZIP').val();
                var customerAddress = $('#SDCUSADDR1').val();
                var customerCity    = $('#SDCUSCITY').val();
                var customerState   = $('#SDCUSSTATE').val();

                var requiredShipPreferred = false;

                if(customerZip.toUpperCase() != setShipZip.toString().toUpperCase()) {
                    requiredShipPreferred = true;
                }
                if(customerAddress.toUpperCase() != setShipAddress.toUpperCase()) {
                    requiredShipPreferred = true;
                }
                if(customerCity.toUpperCase() != setShipCity.toUpperCase()) {
                    requiredShipPreferred = true;
                }
                if(customerState.toUpperCase() != setShipState.toUpperCase()) {
                    requiredShipPreferred = true;
                }
                setTimeout(function() {
                    if (requiredShipPreferred == true) {
                        $('#shippingTab').attr('data-preferred', true);
                    } else {
                        $('#shippingTab').attr('data-preferred', false);
                    }
                }, 1000);
            }
        }
    },

    validateDelInstructions: function(){
    	var minutes = $('#CUSTMINCN').val()!==null ? $('#CUSTMINCN').val().toString() : '';
    	var method = $('#CUSTPCNT').val()!==null ? $('#CUSTPCNT').val().toString() : '';
    	var phone = $('#CUSTCNTPH').cleanVal().toString();
    	var specialinst = $('#SPECIALINST').val().trim();
    	var gated = $('#CUSTGATE').val()!==null ? $('#CUSTGATE').val().toString() : '';
    	var floor = $('#CUSTFLOOR').val()!==null ? $('#CUSTFLOOR').val().toString() : '';
    	var elevator = $('#CUSTELEV').val()!==null ? $('#CUSTELEV').val().toString() : '';
    	var firstRequired = '';
    	var passed = true;

    	method=(minutes=='000') ? '' : method;

    	// Method of contact - CUSTPCNT - required if minutes not blank or 000
    	if (minutes!='' && minutes!='000' && method==''){
    		$('#CUSTPCNT').addClass('profileRequired');
			$('#CUSTPCNT_Required').show();
			if (firstRequired=='') firstRequired = 'CUSTPCNT';
			passed = false;
    	} else {
    		$('#CUSTPCNT').removeClass('profileRequired');
			$('#CUSTPCNT_Required').hide();
    	}

    	// Phone - CUSTCNTPH - required if CUSTPCNT = 'T' or 'C'
    	if ((method=='T' || method=='C' || method=='P') && phone==''){
    		$('#CUSTCNTPH').addClass('profileRequired');
			$('#CUSTCNTPH_Required').show();
			if (firstRequired=='') firstRequired = 'CUSTCNTPH';
			passed = false;
    	} else {
    		$('#CUSTCNTPH').removeClass('profileRequired');
			$('#CUSTCNTPH_Required').hide();
    	}

    	// Gated - CUSTGATE - required (blank selection allowed)
    	if (gated==''){
    		$('#CUSTGATE').addClass('profileRequired');
			$('#CUSTGATE_Required').show();
			if (firstRequired=='') firstRequired = 'CUSTGATE';
			passed = false;
    	} else {
    		$('#CUSTGATE').removeClass('profileRequired');
			$('#CUSTGATE_Required').hide();
    	}

    	// Elevator - CUSTELEV - required if the Delivery Location is 'High-rise Building'
    	if (elevator==''){
    		$('#CUSTELEV').addClass('profileRequired');
			$('#CUSTELEV_Required').show();
			if (firstRequired=='') firstRequired = 'CUSTELEV';
			passed = false;
    	} else {
    		$('#CUSTELEV').removeClass('profileRequired');
			$('#CUSTELEV_Required').hide();
    	}

    	if (passed){
    		ShopdataUI.data =
    		{
				CUSTMINCN : minutes,
				CUSTPCNT : method,
				CUSTCNTPH : phone,
    			SPECIALINST : specialinst,
    			CUSTGATE: gated,
    			CUSTFLOOR : floor,
    			CUSTELEV : elevator
    		};
    	} else {
    		$('#'+firstRequired).focus();
    	}

    	return passed;

    },

    clearRequired: function(){
    	var requiredFields = ["SDCUSFNAME","SDCUSLNAME","SDCUSEMAIL","SDCUSZIP","SDCUSADDR1","SDCUSCITY","SDCUSSTATE",
    	                      "SDCUSPHON1","SDCUSPHON2","SDCUSPTYP1","SDCUSPTYP2","SCSHPFNAME","SCSHPLNAME","SCSHPEMAIL","SCSHPZIP",
    	                      "SCSHPADDR1","SCSHPCITY","SCSHPSTATE","SCSHPPHON1","SCSHPPTYP1","SCSHPPHON2","SCSHPPTYP2"];

    	ShopdataUI.clearRequiredFields(requiredFields);
    },

    clearRequiredFields: function(required){

    	for(i = 0; i < required.length; i++)
        {
    		$('#'+required[i]).removeClass('profileRequired');
    		$('#'+required[i]+'_Required').hide();
    		$('#'+required[i]+'_Invalid').hide();
        }
    },

    PopulatePUStoresList: function(){

    	var padLeft = function(in_val){
        	var chk = true;
        	var val = in_val.toString();
            if (val!='' && val.length < 3){
            	while (chk) {
            		if (val.length!=3){
            			val = '0' + val.toString();
            		} else {
            			chk = false;
            		}
            	}
        	}
            return val;
        }

        var PUStores = ShopdataUI.valuesData.PUSTORES;
        var PUHtml = '<option value"">Store</option>';
        var selectedPUStore = (ShopdataUI.data.length==0) ? '' : ShopdataUI.data.SDPUSTORE;
        if(PUStores.length>0) {
            PUStores.forEach(function (pustore) {
                if (selectedPUStore == pustore.STRNBR) {
                    PUHtml += '<option value="' + pustore.STRNBR + '" selected>' + padLeft(pustore.STRNBR) + ' - ' + pustore.SNAME + '</option>';
                } else {
                    PUHtml += '<option value="' + pustore.STRNBR + '">' + padLeft(pustore.STRNBR) + ' - ' + pustore.SNAME + '</option>';
                }
            });
            $('#TXTPUSTORE').html(PUHtml);
        }

    },

    saveDelInst: function()
    {
    	if (ShopdataUI.validateDelInstructions()){
    		$.ajax({
    	        type: "POST",
    	        global: true,
    	        cache:  false,
    	        url: ShopdataUI.baseURL+'index.php/main/saveDelInst',
    	        data: {
                    	row: JSON.stringify(ShopdataUI.data)
                	  },
    	        dataType: 'json',
    	        success: function(data) {
                    if (typeof data[0].error=="undefined") {
    	        		shopCartUI.displayMsg(data[0].success);
    	        		ShopdataUI.Modal_Close();
    	        	} else {
    	        		shopCartUI.displayMsg(data[0].error);
    	        	}
    	        },
    	        error: function (data){
    	        	shopCartUI.handleCartError(arguments[0],arguments[1]);
    	        }
            });
    	}
    },

    close: function()
    {
    	if (!ShopdataUI.isManager)
        {
            $('#SCSHPSTATE').attr('disabled', false);
            ShopdataUI.copyCustomerAddressToShipping();
		    $('.form-group').removeClass('has-error');
            $('#customerInfoWarning').modal('hide');
            $('.form-group').removeClass('.has-error');

            // if($('#shipAddress .primaryLabelInputSelected').length == 0 && $('#shippingTab').attr('data-preferred') == 'true' && !$('#shippingTab').hasClass('hide')) {
            //     shopCartUI.openModal('modal-md', 'Oops, there was an error', 'Since shipping address is different than customer address please select Preferred Method of Contact on Ship To Info tab.', 'addPreferredContact');
            //     return false;
            // }

    		var row = ShopdataUI.getCustomerFormData();
			ShopdataUI.checkIfValidCustomer(row);
		}
    },

    checkIfValidCustomer: function(row)
    {
        $('.customerInputError').remove();
    	var row = JSON.stringify(row);
    	$.ajax({
	        type: "POST",
	        global: true,
	        cache:  false,
	        url: ShopdataUI.baseURL+'index.php/main/checkIfValidCustomer',
	        data: {
                	row: row
            	  },
	        dataType: 'json',
	        success: function(data) {
	        	if (data.passed && !data.isInvoiceLocked) {
                    $('.newCustomerDataSet').remove();
                	//ShopdataUI.saveCustomerInfo();
                } else {
                	if (!data.passed){
                	    var errorShowing = false;
                		for (i = 0; i < data.missing.length; i++)
            			{
                			$('#'+data.missing[i]).parent().addClass('has-error');
                            $('#'+data.missing[i]).after('<div class="customerInputError text-danger"><i class="fa fa-exclamation-triangle"></i> Input is required</div>');
                            errorShowing = true;
            			}

            			var duplicatePhoneError = false;
                        for (i = 0; i < data.invalid.length; i++)
                        {
                            var msg = 'Input is required';
                            if(data.invalid[i] == 'SDCUSEMAIL' || data.invalid[i] == 'SCSHPEMAIL' || data.invalid[i] == 'additionalPhone') {
                                if(data.msg[i] == '') {
                                    msg = 'Invalid email address';
                                } else {
                                    if(data.invalid[i] == 'additionalPhone') {
                                        shopCartUI.displayMsg(data.invalidError, 'Oops, There was an error saving the customers info');
                                        duplicatePhoneError = true;
                                    }
                                    msg = data.msg;
                                }
                            }
                            $('#'+data.invalid[i]).parent().addClass('has-error');
                            $('#'+data.invalid[i]).after('<div class="customerInputError text-danger"><i class="fa fa-exclamation-triangle"></i> '+msg+'</div>');

                            errorShowing = true;
                        }

                        if(duplicatePhoneError) {
                            shopCartUI.displayMsg(msg, 'Oops, There was an error saving the customers info');
                        } else if(errorShowing) {
                            shopCartUI.displayMsg(data.invalidError, 'Oops, There was an error saving the customers info');
                        }

                		if(data.tabError == 0) {
                		    $('#profileTab a').trigger('click');
                        } else {
                            $('#shippingTab a').trigger('click');
                        }

                	} else {
                		ShopdataUI.clearRequired();
                	}
                	if (data.isInvoiceLocked) shopCartUI.displayMsg(data.invoiceError);
                }
	        },
	        error: function (data){
	        	shopCartUI.handleCartError(arguments[0],arguments[1]);
	        }
        });
    },

    formatPhoneNumber: function(s) {
        var s2 = (""+s).replace(/\D/g, '');
        var m = s2.match(/^(\d{3})(\d{3})(\d{4})$/);
        return (!m) ? null : "(" + m[1] + ") " + m[2] + "-" + m[3];
    },

    saveCustomerInfo: function () {
        //SETTING A WAIT PERIOD ON THE SAVE FUNCTION TO LET THE FORM SYNC ANY CHANGES MADE FROM THE CUSTOMER
        //TAB TO THE SHIPPING TAB. IF THIS ISN'T HERE AND THE USER CLICKS ON SAVE TO FAST THE CHANGES WONT SYNC IN TIME
        ShopdataUI.Loading_On();
        setTimeout(function() {
            var row = ShopdataUI.getCustomerFormData();
            $('.customerInputError').remove();
            $('#pastPurchases').removeClass('hide');
            $.ajax({
                url: ShopdataUI.baseURL + 'index.php/main/save_customer_info',
                dataType: 'json',
                type: 'post',
                data: {row:row, 'GREETING_ID': ShopdataUI.data.SDGREETID},
                success: function (data) {
                    if(data.success) {
                        shopCartUI.updateAppSections('customerInfoSection');
                        shopCartUI.showMainWindow();
                        shopCartUI.QuickSearchTermDropdownManagement();
                        $('#customerInfoArea').addClass('hide').html('');
                        $('#footer').removeClass('hide');
                        $('.ui-datepicker').remove();
                        $('#customerInfoWarning').modal('hide');
                        if(data.changed) {
                            $('#cmdEngage').prop('data-changed', true);
                        }
                        ShopdataUI.UpdatePUStoresList();
                        shopCartUI.checkForSkuFitWarnings();
                    } else {
                        if(data.hasOwnProperty('passed') && data.passed == false) {
                            ShopdataUI.displayCustomerProfileErrors(data);
                        } else {
                            shopCartUI.handleFailedAjaxCall(data);
                        }
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    shopCartUI.displayMsg('Failed to save customer info, try again', 'Error');
                }
            });
        }, 601);
    },

    displayCustomerProfileErrors: function(data) {
        var errorShowing = false;
        $('.form-group').removeClass('has-error');
        for (i = 0; i < data.missing.length; i++)
        {
            $('#'+data.missing[i]).parent().addClass('has-error');
            $('#'+data.missing[i]).after('<div class="customerInputError text-danger"><i class="fa fa-exclamation-triangle"></i> Input is required</div>');
            errorShowing = true;
        }

        var duplicatePhoneError = false;
        for (i = 0; i < data.invalid.length; i++)
        {
            var msg = 'Input is required';
            if(data.invalid[i] == 'SDCUSEMAIL' || data.invalid[i] == 'SCSHPEMAIL' || data.invalid[i] == 'additionalPhone') {
                if(data.msg[i] == '') {
                    msg = 'Invalid email address';
                } else {
                    if(data.invalid[i] == 'additionalPhone') {
                        shopCartUI.displayMsg(data.invalidError, 'Oops, There was an error saving the customers info');
                        duplicatePhoneError = true;
                    }
                    if(data.msg[i] != '') {
                        msg = data.msg[i];
                    }
                }
            }

            if(data.msg) {
                $('#' + data.invalid[i]).parent().addClass('has-error');
                $('#' + data.invalid[i]).after('<div class="customerInputError text-danger"><i class="fa fa-exclamation-triangle"></i> ' + msg + '</div>');
            }

            errorShowing = true;
        }

        if(duplicatePhoneError) {
            shopCartUI.displayMsg(msg, 'Oops, There was an error saving the customers info');
        } else if(errorShowing) {
            shopCartUI.displayMsg(data.invalidError, 'Oops, There was an error saving the customers info');
        }

        if(data.tabError == 0) {
            $('#profileTab a').trigger('click');
        } else {
            $('#shippingTab a').trigger('click');
        }
    },

    UpdatePUStoresList: function(){
    	var zip = $('#TXTDELZIP').val();
		$.ajax({
		    type: "POST",
		    global: false,
		    url: ShopdataUI.baseURL+'index.php/main/UpdatePUStoresList',
		    data: {
		           	zip: zip
		       	  },
		    dataType: 'json',
		    success: function(data) {
		    	ShopdataUI.valuesData.PUSTORES = data.PUSTORES;
		    	ShopdataUI.PopulatePUStoresList();
		    },
		    error: function (data){
		    	shopCartUI.checkIfNetworkError();
		    }
	   	});

    },

    changeDeliveryZip: function()
    {
    	var zip = $("#TXTDELZIP").val().trim();

    	if (ShopdataUI.ValidZIP(zip)) {
            $.post(
				ShopdataUI.baseURL+'index.php/main/ShopData_ChangeDeliveryZip',{ zip: zip, GREETING_ID: ShopdataUI.data.SDGREETID },
				function(data)
				{
				    if(data.success) {
                        ShopdataUI.data.SCSHPZIP = zip;
                        ShopdataUI.PopulatePUStoresList();
                        shopCartUI.updateAppSections('customerInfoSection');
                        $('#TXTDELZIP').val(zip);
                    } else {
                        $('#TXTDELZIP').val('');
				        shopCartUI.handleFailedAjaxCall(data);
                    }
				},
				'json'
			).fail(
					function(data){
						shopCartUI.checkIfNetworkError();
					}
			);
       	} else {
       		if ($("#TXTDELZIP").val()!==''){
       			shopCartUI.displayMsg("Invalid ZIP code. Please enter a valid ZIP code.");
       		}
      	}
    },

    changePUStore: function()
    {
    	var pustore = $("#TXTPUSTORE").val().trim();

    	if(ShopdataUI.isCartReadOnly) {
            shopCartUI.displayMsg('Invoice can not be maintained.');
            return false;
        }

        $.post(
                ShopdataUI.baseURL+'index.php/main/ShopData_ChangePUStore',{ pustore: pustore, GREETING_ID: ShopdataUI.data.SDGREETID},
                function(data)
                {
                    if(data.success) {
                        ShopdataUI.data.SDPUSTORE = pustore;
                        shopCartUI.updateCustomersAvailAndCart(data);
                    } else {
                        if(ShopdataUI.data.SDPUSTORE > 0) {
                            $('#TXTPUSTORE').val(ShopdataUI.data.SDPUSTORE);
                        } else {
                            $("#TXTPUSTORE").val($("#TXTPUSTORE option:first").val());
                        }
                       shopCartUI.handleFailedAjaxCall(data);
                    }
                },
                'json'
        ).fail(
                function(data){
                    shopCartUI.checkIfNetworkError();
                }
        );
    },

    discountCart: function()
    {
    	var discountCode = $("#SCDSCCODE").val().trim();
    	$.ajax({
	        type: "POST",
	        global: false,
	        url: ShopdataUI.baseURL+'index.php/main/discountCart',
	        data: {
                	discountCode: discountCode
            	  },
	        dataType: 'json',
	        success: function(data) {
	        	$('#discountResponse').html(data.response);
	        },
	        error: function (data){
	        	shopCartUI.checkIfNetworkError();
	        }
        });
       	return false;
    },

    countCharacters: function(e)
    {
    	if ($("#TXTDELZIP").val().trim().length == 5){
	    	ShopdataUI.changeDeliveryZip();
	    	$("#TXTDELZIP").prop('disabled',ShopdataUI.data.SDCUSADDR1 != '');
	    }
    	if (e.which==13) {
    		$("#TXTDELZIP").blur();
    	}
    },

    countDiscountCharacters: function(e)
    {
    	if ($("#SCDSCCODE").val().trim().length == 15){
	    	ShopdataUI.discountCart();
	    }
    	if (e.which==13) {
    		$("#SCDSCCODE").blur();
    	}
    },

    countZipCharacters: function(e)
    {
    	var zip = $(this).val().trim();
    	if (zip.length == 5){
	    	ShopdataUI.checkIfValidZip(zip,$(this)[0].id);
	    }
    },

    isCustomerInfoChanged: function ()
    {
    	var fields = ["SDCUSFNAME","SDCUSMID","SDCUSLNAME","SDCUSEMAIL","SDCUSZIP","SDCUSADDR1","SDCUSCITY","SDCUSSTATE",
    	                      "SDCUSPHON1","SDCUSPHON2","SDCUSPTYP1","SDCUSPTYP2",
                            "SCSHPFNAME","SCSHPMID","SCSHPLNAME","SCSHPEMAIL","SCSHPZIP",
    	                      "SCSHPADDR1","SCSHPCITY","SCSHPPHON1","SCSHPPTYP1","SCSHPPHON2","SCSHPPTYP2"];

    	var isChanged = false;
    	if($('#lookupCustomerWindow').parent().hasClass('hide')) {
            var val = '';
            for (i = 0; i < fields.length; i++) {
                if ($.inArray(fields[i], ['SDCUSPHON1', 'SDCUSPHON2', 'SCSHPPHON1', 'SCSHPPHON2']) == -1) {
                    val = $('#' + fields[i]).val();
                } else {
                    val = $('#' + fields[i]).cleanVal().toString();
                    if(val == '') {
                        val = 0;
                    }
                }

                if (val != ShopdataUI.data[fields[i]]) {
                    if($('#shippingTab').hasClass('hide') && fields[i].substring(0, 2) != 'SC') {
                        if (fields[i] != 'SDCUSPTYP1' && ShopdataUI.data.SDCUSPHON1 == 0) {
                            isChanged = true;
                            break;
                        }
                    } else if(!$('#shippingTab').hasClass('hide')) {
                        if(!ShopdataUI.checkIfSyncIssue()) {
                            isChanged = true;
                            break;
                        }
                    }
                }
            }
        }

    	return isChanged;
    },

    checkIfSyncIssue: function() {
        return false;
    },

    cmdCustomerSize_Save: function(adultsMode)
    {
        var names = [], types = [], data = '';
        //var form = '';
        if (ShopdataUI.isLookup){
        	//form = (adultsMode ? 'LSDADULTS' : 'LSDCHILDREN');
        } else {
        	//form = (adultsMode ? 'SDADULTS' : 'SDCHILDREN');
        }
        var form = (adultsMode ? 'SDADULTS' : 'SDCHILDREN');
        //SDADULTS_NAME
        var dataKey = (adultsMode ? 'SDADULTDTA' : 'SDCHILDDTA');
        var size = 0;

        $('.customerPersonalDetails .'+form+'_NAME').each(function(index) {
            names.push($(this).val());
        });

        $('.customerPersonalDetails .'+form+'_TYPE').each(function() {
            types.push($(this).val());
        });

        for(var i = 0; i < names.length; i++)
        {
            data += names[i] + ':' + types[i] + ';';
            size++;
        }

        ShopdataUI.data[form] = size.toString();
        ShopdataUI.data[dataKey] = data;
    },

    cmdCustomerSize_Deserialize: function(adultsMode)
    {
        var objs = [], nameType = '';
        var data = (adultsMode ? ShopdataUI.data.SDADULTDTA : ShopdataUI.data.SDCHILDDTA);
        var namesTypes = data.split(';').filter(function(v){return v!==''});

        for(var i = 0; i < namesTypes.length; i++)
        {
            nameType = namesTypes[i].split(':');
            objs.push(
                {
                    name: nameType[0],
                    type: nameType[1]
                }
            );
        }

        return objs;
    },

    datePickerToAS400: function(date)
    {
        if(typeof date != 'undefined') {
            return (date.length == 10
                ? date.substr(6, 4) + date.substr(0, 2) + date.substr(3, 2)
                : '0');
        }
        return '0';
    },

    datePickerFromAS400: function(date400)
    {
        if(date400) {
            date400 = date400.toString();

            return (date400.length == 8
                ? date400.substr(4, 2) + '/' + date400.substr(6, 2) + '/' + date400.substr(0, 4)
                : '');
        }
    },

    timeFromAS400: function(time400)
    {
        time400 = time400.toString();
    	var hr  = time400.substr(0,2);
        var min = time400.substr(2,2);
        var amPm = (hr >= 12 ? 'PM' : 'AM');
        var hrBase12 = (hr % 12);
        if (hrBase12 == 0) hrBase12 = "12";

        return hrBase12 + ':' + min + ' ' + amPm;
    },

    getCustomerFormData: function()
    {
    	// Update SDADULTS,SDADULTDTA
        ShopdataUI.cmdCustomerSize_Save(true);
        // Update SDCHILDREN,SDCHILDDTA
        ShopdataUI.cmdCustomerSize_Save(false);

        ShopdataUI.data =
        {
            // *Header - constant from shipAddress
            SDGREETID:  ShopdataUI.data.SDGREETID,
            SDRETRNCUS: ShopdataUI.data.SDRETRNCUS,
            SDCARTID:   ShopdataUI.data.SDCARTID,
            SDCARTSTR:  ShopdataUI.data.SDCARTSTR,
            SDEMPNUM:   ShopdataUI.data.SDEMPNUM,
            SDCARTHFC:  ShopdataUI.data.SDCARTHFC,
            SDSHOPDATE: ShopdataUI.data.SDSHOPDATE,
            SDSHOPTIME: ShopdataUI.data.SDSHOPTIME,
            SDCUSTNBR:  ShopdataUI.data.SDCUSTNBR,

            // *Data - update now
            SDCUSZIP:   $('#SDCUSZIP').val(),
            SDCUSEMAIL: $('#SDCUSEMAIL').val().toUpperCase(),
            SDCUSPHON1: $('#SDCUSPHON1').cleanVal().toString(),
            SDCUSFNAME: $('#SDCUSFNAME').val().toUpperCase(),
            SDCUSMID:   $('#SDCUSMID').val().toUpperCase(),
            SDCUSLNAME: $('#SDCUSLNAME').val().toUpperCase(),
            SDCUSTFETR: $('#SDCUSTFETR').val(),
            SDCUSADDR1: $('#SDCUSADDR1').val().toUpperCase(),
            SDCUSADDR2: $('#SDCUSADDR2').val().toUpperCase(),
            SDCUSCITY:  $('#SDCUSCITY').val().toUpperCase(),
            SDCUSSTATE: $('#SDCUSSTATE').val()!==null ? $('#SDCUSSTATE').val().toString() : '',
            SDCUSPHON1: $('#SDCUSPHON1').cleanVal().toString(),
            SDCUSPTYP1: $('#SDCUSPTYP1').val(),
            SDCUSPHON2: $('#SDCUSPHON2').cleanVal().toString(),
            SDCUSPTYP2: $('#SDCUSPTYP2').val(),

            //PREFERREDPHONE: PREFERREDPHONE, //$('.primaryLabelInputSelected').attr('data-value'),
            //PREFERREDTYPE: PREFERREDTYPE, //$('.primaryLabelInputSelected').attr('data-type'),

            CUSTOMER_OPTION: $('#CUSTOMER_OPTION').is(':checked') ? 'Y' : 'N',
            CUSTOMER_OPTION_SELECTION: $('#CUSTOMER_OPTION').is(':checked') ? $('#CUSTOMER_OPTION_SELECTION').val() : '',
            CUSTOMER_OPTION_ADDITIONAL_INPUT: $('#CUSTOMER_OPTION_ADD_OPTION').is(':checked') ? $('#CUSTOMER_OPTION_ADD_OPTION').val() : '',
            CUSTEOPIO: $('#CUSTEOPIO').is(':checked') ? 'I' : 'O',
            CUSTSHIPEOPIO: $('#CUSTSHIPEOPIO').is(':checked') ? 'I' : 'O',
            MDROBO:     $('#MDROBO').is(':checked') ? $('#MDROBO').val() : '',

            SDADULTS:   ShopdataUI.data.SDADULTS,
            SDADULTDTA: ShopdataUI.data.SDADULTDTA,
            SDCHILDREN: ShopdataUI.data.SDCHILDREN,
            SDCHILDDTA: ShopdataUI.data.SDCHILDDTA,

            SDMKTGDTA:  $('#SDMKTGDTA').val()!==null ? $('#SDMKTGDTA').val().toString() : '',
            SDDEPTLIKE: $('#SDDEPTLIKE').val()!==null ? $('#SDDEPTLIKE').val().toString() : '',
            SDDEPTSHOP: $('#SDDEPTSHOP').val()!==null ? $('#SDDEPTSHOP').val().toString() : '',
            SDCOMPSHOP: $('#SDCOMPSHOP').val()!==null ? $('#SDCOMPSHOP').val().toString() : '',
            SDCOMPNEXT: $('#SDCOMPNEXT').val()!==null ? $('#SDCOMPNEXT').val().toString() : '',
            SDWANTDATE: ShopdataUI.datePickerToAS400($('#SDWANTDATE').val()),
            SDLASTDATE: ShopdataUI.datePickerToAS400($('#SDLASTDATE').val()),
            SDFOLLOWUP: $('#SDFOLLOWUP').val(),
            SDEXITTYPE: '',
            SDEXITTIME: ShopdataUI.data.SDEXITTIME,
            SCSHPFNAME : $('#SCSHPFNAME').val().toUpperCase(),
            SCSHPMID   : $('#SCSHPMID').val().toUpperCase(),
            SCSHPLNAME : $('#SCSHPLNAME').val().toUpperCase(),
            SCSHPEMAIL : $('#SCSHPEMAIL').val().toUpperCase(),
            SCSHPADDR1 : $('#SCSHPADDR1').val().toUpperCase(),
            SCSHPADDR2 : $('#SCSHPADDR2').val().toUpperCase(),
            SCSHPCITY  : $('#SCSHPCITY').val().toUpperCase(),
            SCSHPSTATE : $('#SCSHPSTATE').val()!==null ? $('#SCSHPSTATE').val().toString() : '',
            SCSHPZIP   : $('#SCSHPZIP').val().toUpperCase(),
            SCSHPPHON1 : $('#SCSHPPHON1').cleanVal().toString(),
            SCSHPPTYP1 : $('#SCSHPPTYP1').val(),
            SCSHPPHON2 : $('#SCSHPPHON2').cleanVal().toString(),
            SCSHPPTYP2 : $('#SCSHPPTYP2').val(),
            SDCUSTLAT  : $('#SDCUSTLAT').val(),
            SDCUSTLNG  : $('#SDCUSTLNG').val(),
            SCSHPCUSTLAT  : $('#SCSHPCUSTLAT').val(),
            SCSHPCUSTLNG  : $('#SCSHPCUSTLNG').val(),
            SCSELLINV  : ShopdataUI.data.SCSELLINV,
            //SCDSCCODE : $CACHE('#SCDSCCODE').val().toUpperCase(),
        };

        // Additional Phones
        if($('#pullPhoneNumbers .additionalPhone').length>0) {
            var count = $('#pullPhoneNumbers .additionalPhone').length;
            var phones = [];
            if(count>0) {
                $('#pullPhoneNumbers .additionalPhone').each(function() {
                    var phone = $(this).attr('data-phone');
                    var type = $(this).attr('data-type');
                    if(phone != '' && type != '') {
                        phone = phone.replace(/\D/g,'');
                        phones.push({PHONE:phone,TYPE:type});
                    }
                });
            }
            ShopdataUI.data['PHONES'] = phones;
        }

        $('#cmdLogin').hide();

        return ShopdataUI.data;
    },

    postSave: function()
    {
        $.ajax({
            url: ShopdataUI.baseURL+'index.php/main/ShopData_Save',
            type: 'post',
            data: {customer: JSON.stringify(ShopdataUI.data)},
            dataType: 'html',
            complete: function(data) {
                ShopdataUI.destroyCustomerInfo();
                $('#pastPurchases').removeClass('hide');
                $('#lookupCustomer').addClass('hide');
                shopCartUI.updateAppSections();
            },
            error: function() {
                shopCartUI.handleCartError();
            }
        });
        return false;
    },

    toggleCustomerOptionInput: function() {
        if(ShopdataUI.data.CUSTOMER_OPTION === 'N') {
            $('#CUSTOMER_OPTION_SELECTION, #CUSTOMER_OPTION_ADDITIONAL_INPUT').hide();
        }
        $('body').on('click', '#CUSTOMER_OPTION', function () {
            if($('#CUSTOMER_OPTION_SELECTION').length > 0) {
                var originalValue = $('#CUSTOMER_OPTION_SELECTION').attr('data-original-value');
                if ($(this).is(':checked')) {
                    $('#CUSTOMER_OPTION_SELECTION').show().val(originalValue);
                    $('#CUSTOMER_OPTION_ADDITIONAL_INPUT').show();
                } else {
                    $('#CUSTOMER_OPTION_SELECTION').parent().removeClass('has-error').find('.customerInputError').remove();
                    $('#CUSTOMER_OPTION_SELECTION, #CUSTOMER_OPTION_ADDITIONAL_INPUT').hide();
                }
            }
        });
    },

    cmdCustomerSize: function()
    {
        var visitorType = '';
        var visitors = $(this).attr('data-number');
        var clonedElem = '';
        var countClass = '';
        if($(this).hasClass('adultsNumberSelection')) {
            visitorType = 'adultData';
            countClass     = 'adultCount';
            clonedElem = $('#customerDetailsCloneAdult').html();
        } else {
            visitorType = 'childData';
            countClass     = 'childCount';
            clonedElem = $('#customerDetailsCloneChild').html();
        }
        var currentVisitors = $('#'+visitorType+' .row').length;

        if(visitors > 0) {
            if(visitors > currentVisitors) {
                visitors = visitors - currentVisitors;
                for(var i = 0; i< visitors; i++) {
                    $(clonedElem).find('.'+countClass).html((i+1)+'.');
                    $('#' + visitorType).append(clonedElem);
                }
            } else {
                for(var i = 1; i < (currentVisitors+1); i++) {
                    if(i > visitors) {
                        $('#' + visitorType + ' .row:nth-child('+i+')').addClass('markedForRemoval');
                    }
                }
                $('.markedForRemoval').remove();
            }
        } else {
            $('#'+visitorType).html('');
        }

        $('#'+visitorType+' .row').each(function(index) {
            $(this).find('.'+countClass).html((index+1)+'.');
        })
    },

    // ECMA-262 5th Edition Array.prototype.indexOf
    indexOf: function(src, searchElement /*, fromIndex */ )
    {
        "use strict";
        if (src == null) {
            throw new TypeError();
        }
        var t = Object(src);
        var len = t.length >>> 0;
        if (len === 0) {
            return -1;
        }
        var n = 0;
        if (arguments.length > 1) {
            n = Number(arguments[1]);
            if (n != n) { // shortcut for verifying if it's NaN
                n = 0;
            } else if (n != 0 && n != Infinity && n != -Infinity) {
                n = (n > 0 || -1) * Math.floor(Math.abs(n));
            }
        }
        if (n >= len) {
            return -1;
        }
        var k = n >= 0 ? n : Math.max(len - Math.abs(n), 0);
        for (; k < len; k++) {
            if (k in t && t[k] === searchElement) {
                return k;
            }
        }
        return -1;
    },

    Engage: function(e)
    {
        e.preventDefault();
        if (!ShopdataUI.isManager)
		{
            var button_input = $('#cmdEngage').data('buttoninput');
    	    if ($('#engageCustomerWindow').is(':visible') || button_input == 'none'){
                $('#engageCustomerWindow').modal('hide');
                var button_input_data = ShopdataUI.getButtonInputData();
                ShopdataUI.status = $(this).data('status');
                $('#prevSkus, #divCustomerHeader').show();
    	    	$('#ui-datepicker-div').hide();
                ShopdataUI.isCartReadOnly = false;
    	        ShopdataUI.LoadData(false);
                $('#searchResultsArea #searchBody').html('');
                ShopdataUI.engagedCustomer = 'y';
                $('.newCustomerDataSet').remove();
                $('#TXTDELZIP').attr('disabled', false);
            } else {
                var formHeader = SalesUp.getConfigValue('UI', 'button_input-header', 'engage');
                var btnCaption = SalesUp.getConfigValue('UI', 'button_input-submit', 'engage');
                if (button_input == 'button'){
                    SalesUp.showButtonInput('engage', '', '', formHeader, 'engageCustomerWindow');
                } else {
                    SalesUp.showButtonInput('engage', 'btnEngage', btnCaption, formHeader, 'engageCustomerWindow');
                }
            }
		}
    },

    checkButtonInputs: function()
    {
        var required = 0;
        $.each($('#frmButtonInput input'), function(){
            var msg = '';
            if ($(this).hasClass('required') && $(this).val()==''){
                msg = 'Please fill in this information.';
                $(this).addClass('has-error');
                required++;
            } else {
                $(this).removeClass('has-error');
            }
            $('#feedback-'+$(this).attr('id')).html(msg);        
        });
        return required == 0;
    },

    getButtonInputData: function()
    {
        var data = [];
        $.each($('#frmButtonInput input'), function(){
            data.push({ [$(this).attr('id')] : $(this).val() });
        });
        return JSON.stringify(data);
    },

    ExitFloor: function(e)
    {
        e.preventDefault();
        var button_input = $('#cmdExitFloor').data('buttoninput');
        if ($('#exitFloorWindow').is(':visible') || button_input == 'none'){
            var button_input_data = ShopdataUI.getButtonInputData();
            $('#exitFloorWindow').modal('hide');
            $.ajax({
                url: ShopdataUI.baseURL+'index.php/main/exitFloor',
                data: { status : '', button_input_data : button_input_data},
                dataType: 'html',
                type: 'post',
                success: function() {
                    shopCartUI.logOut();
                },
                error: function() {
                    shopCartUI.displayMsg('Exit floor failed, please try refreshing your screen and trying again.', 'Error');
                }
            });
        } else {
            var formHeader = SalesUp.getConfigValue('UI', 'button_input-header', 'exit');
            var btnCaption = SalesUp.getConfigValue('UI', 'button_input-submit', 'exit');
            if (button_input == 'button'){
                SalesUp.showButtonInput('exit', '', '', formHeader, 'exitFloorWindow');
            } else {
                SalesUp.showButtonInput('exit', 'btnExit', btnCaption, formHeader, 'exitFloorWindow');
            }
        }
    },

    ExitCustomer: function()
    {
        if (!ShopdataUI.isManager)
		{
            var button_input = $('#cmdExitCustomer').data('buttoninput');
            if ($('#exitCustomerWindow').is(':visible') || button_input == 'none'){
                if (ShopdataUI.checkButtonInputs()){
                    var button_input_data = ShopdataUI.getButtonInputData();
                    $('#exitCustomerWindow').modal('hide');
                    $('#prevSkus, #divCustomerHeader').hide();
                    $('#cmdEngage, #cmdLogin').show();
                    $('#cmdLogin').attr('disabled', false);
                    // initialiaze the ShopdataUI.data to an empty array
                    ShopdataUI.data = {};
                    ShopdataUI.engagedCustomer = 'y';
                    shopCartUI.lastSearch = '';
                    // Reset Catalog UI - Hide loading finally
                    $('#customerInfoSection li.list-group-item').removeClass('activeCustomer');
                    $.ajax({
                        url: ShopdataUI.baseURL+'index.php/main/exitCustomer',
                        data: { button_input_data : button_input_data},
                        dataType: 'html',
                        type: 'post',
                        success: function() {
                            ShopdataUI.sync_customer = true;
                            location.reload();
                        },
                        error: function() {
                            shopCartUI.displayMsg('Exit customer failed, please try refreshing your screen and trying again.', 'Error');
                        }
                    });
                }
                
            } else {
                var formHeader = SalesUp.getConfigValue('UI', 'button_input-header', 'disengage');
                var btnCaption = SalesUp.getConfigValue('UI', 'button_input-submit', 'disengage');
                if (button_input == 'button'){
                    SalesUp.showButtonInput('disengage', '', '', formHeader, 'exitCustomerWindow');
                } else {
                    SalesUp.showButtonInput('disengage', 'btnDisengage', btnCaption, formHeader, 'exitCustomerWindow');
                }
            }
		}
    },

    ClearCustomerForm: function() {
    	 var TextInputs = ['SDCUSFNAME', 'SDCUSMID', 'SDCUSLNAME', 'SDCUSEMAIL', 'SDCUSZIP', 'SDCUSADDR1',
    	                   'SDCUSADDR2', 'SDCUSCITY', 'SDCUSSTATE', 'SDCUSPHON1', 'SDCUSPTYP1', 'SDCUSPHON2',
    	                   'SDCUSPTYP2', 'SDCUSTFETR', 'SDFOLLOWUP', 'SDWANTDATE', 'SDLASTDATE', 'SDEXITTYPE',
    	                  'SCSHPFNAME', 'SCSHPMID', 'SCSHPLNAME', 'SCSHPEMAIL', 'SCSHPZIP', 'SCSHPADDR1',
    	                  'SCSHPADDR2', 'SCSHPCITY', 'SCSHPSTATE', 'SCSHPPHON1', 'SCSHPPTYP1',
    	                  'SCSHPPHON2', 'SCSHPPTYP2', 'SCDSCCODE','INTDEL','MAJORINT'];

    	for(i = 0; i < TextInputs.length; i++)
        {
    		if ($.inArray(TextInputs[i],['SDCUSSTATE','SDEXITTYPE','SCSHPSTATE'])==-1){
    			$('#'+TextInputs[i]).val('');
    		} else {
    			$('#'+TextInputs[i]).find("option:selected").removeAttr("selected");
    			//$CACHE('#'+TextInputs[i]).multiselect('refresh');
    		}
        }

    	$('.SDCUSPHON1, .SDCUSPHON2, .SCSHPPTYP1, .SCSHPPTYP2').removeClass('buttonActive');
    	$('.SDCUSPTYP1, .SDCUSPTYP2, .SCSHPTYP1, .SCSHPTYP2').removeClass('buttonActive');
    	$('#discountResponse').html('');

    },

    LoadData: function(row)
    {
        $.ajax({
            url: ShopdataUI.baseURL+'index.php/main/ShopData_Read',
            data: { row: row, status: ShopdataUI.status, button_input_data: ShopdataUI.getButtonInputData()},
            type: 'post',
            dataType: 'json',
            success: function(loadData) {
                if(loadData.success) {
                    ShopdataUI.data = loadData.data.customer;
                    if (ShopdataUI.data.CUSTCNTPH != '' || ShopdataUI.data.SDCUSEMAIL != '' || ShopdataUI.data.SDCUSTNBR > 0) {
                        $('#pastPurchases').removeClass('hide');
                    } else {
                        $('#pastPurchases').addClass('hide');
                    }
                    if (ShopdataUI.data.SDGREETID > 0) {
                        $('#prevSkus').removeClass('hide');
                    } else {
                        $('#prevSkus').addClass('hide');
                    }

                    $('#currentCustomerBox').attr('data-customer', ShopdataUI.data);
                    var greetid = -1;
                    if (typeof ShopdataUI.data.SDGREETID != 'undefined') {
                        greetid = ShopdataUI.data.SDGREETID;
                    }

                    if (!$.isEmptyObject(ShopdataUI.data)) {
                        if (greetid != ShopdataUI.data.SDGREETID && $('#searchResults').length > 0) {
                            $('#searchResults').html('');
                            shopCartUI.lastSearch = "";
                        }
                    }
                    shopCartUI.updateAppSections('customerInfoSection', false, 'n');
                    setTimeout(function () {
                            updateAppHeader(loadData.data.hfcstatus);
                    }, 500);
                    shopCartUI.enableComponentAvailability();
                    shopCartUI.checkScreenWidth();

                    if (ShopdataUI.openCustomerInfo) {
                        setTimeout(function () {
                            ShopdataUI.openCustomerInfoPage(false);
                            ShopdataUI.openCustomerInfo = false;
                        }, 500);
                    }
                    ShopdataUI.checkForCustomerRecordLock();

                    if (ShopdataUI.data.SDCARTID > 0 || ShopdataUI.data.SDCUSEMAIL != '' || ShopdataUI.data.SDCUSPHON1 != 0) {
                        $('#lookupCustomer').addClass('hide');
                    } else {
                        $('#lookupCustomer').removeClass('hide');
                    }
                    $('#TXTDELZIP').val(ShopdataUI.data.SDCUSZIP);
                    if (typeof ShopdataUI.data.SDCUSADDR1 != 'undefined' && ShopdataUI.data.SDCUSADDR1 != '') {
                        $('#TXTDELZIP').attr('disabled', true);
                    } else {
                        $('#TXTDELZIP').attr('disabled', true);
                    }
                } else {

                }
            },
            error: function() {
                shopCartUI.handleCartError(arguments[0],arguments[1]);
            }
        });

    },

    LoadData_Success: function()
    {

    },

    LoadDData_Success: function()
    {
        var i = 0, j = 0, valueIdx = '';

        $('#LSDCUSEMAIL').val('');
        $('#LSDCUSPHON1').val('');

        //  SDPUSTORE
        ShopdataUI.setSelectedPUStore();

        var TextInputs = ['SDCUSTFETR', 'SDFOLLOWUP'];
		var LoadText = '';

        for(i = 0; i < TextInputs.length; i++)
        {
			LoadText = ShopdataUI.data[TextInputs[i]];

			// Set text input
			if (LoadText!=''){
				$CACHE('#L'+TextInputs[i]).val(LoadText);
			} else {
				$CACHE('#L'+TextInputs[i]).val('');
			}
        }

        // NAMESTYPES PAIRS
        /*
            SDADULTS
            SDADULTDTA
        */
        ShopdataUI.cmdCustomerSize(null, true);
        /*
            SDCHILDREN
            SDCHILDDTA
         */
        ShopdataUI.cmdCustomerSize(null, false);



    },

    setSelectValue: function(field)
    {
    	$CACHE('#'+field)[0].selectedIndex = -1;
    	if(ShopdataUI.data[field]!="" && ShopdataUI.data[field]!='0-1')
        {
            $CACHE('#'+field).each(function(){
                $CACHE('#'+field).val(ShopdataUI.data[field]);
            });
        } else {
        	$CACHE('#'+field).each(function(){
                $CACHE('#'+field).val(ShopdataUI.dft[field]);
            });
        }
    },

    setDeliveryZip: function()
    {
    	if (!$.isEmptyObject(ShopdataUI.data))
		{
			if(typeof ShopdataUI.data.SCSHPZIP == 'undefined') {
				ShopdataUI.data.SCSHPZIP = '0';
			}
	    	var delZip = ShopdataUI.data.SCSHPZIP.trim().length==0 ? ShopdataUI.data.SDCUSZIP.trim() : ShopdataUI.data.SCSHPZIP.trim();
	        if (delZip != '') ShopdataUI.UpdatePUStoresList();
		}
    },

    setSelectedPUStore: function()
    {
        if(typeof ShopdataUI.data.SDPUSTORE != 'undefined' && ShopdataUI.data.SDPUSTORE != 0)
        {
        	$('#TXTPUSTORE').val(ShopdataUI.data.SDPUSTORE);
        } else {
        	$('#TXTPUSTORE').val('Store');
        }
    },

    CreateCart: function(row)
    {
        if(ShopdataUI.data.SDCARTID !== '0') return true;

        // Create Cart
        $.post(
        		ShopdataUI.baseURL+'index.php/main/ShopData_CreateCart',
        		{
                    CustomerNumber: ShopdataUI.data.SDCUSTNBR
                },
                function(data)
                {
                    if(data.success) {
                        ShopdataUI.data.SDCARTID = data.CartID.toString();
                        shopCartUI.addToCart(row);
                        return true;
                    } else {
                        shopCartUI.displayMsg('Error occurred while creating cart. Please contact support.');
                        return false;
                    }
                },
                'json'
        ).fail(
        		function(){
        			shopCartUI.handleCartError(arguments[0],arguments[1]);
        		}
        );


    },

    cmdLogout: function()
    {
        // Logout
        shopCartUI.logOut();
    },

    ValidEmail: function(email)
    {
        var atpos=email.indexOf("@");
        var dotpos=email.lastIndexOf(".");
        var atpos2=email.lastIndexOf("@");

        return ((atpos<1 || dotpos<atpos+2 || dotpos+2>=email.length || atpos!==atpos2) ? false : true);
    },

    ValidateEmailFormat: function(e)
    {
    	var id = e.target.id;
    	var email = $('#'+id).val().trim();
    	if (email!='' && !(email=='*NONE' || email=='*none')) {
    	    if(!ShopdataUI.ValidEmail(email)) {
                shopCartUI.displayMsg('Error Invalid email');
                //$('#'+id).focus();
                return false;
            }
    	}
    	return true
    },

    ValidZIP: function(zip)
    {
    	return (zip.trim().match(/^\d{5}(?:[-\s]\d{4})?$/) ? true : false);
    },

    checkIfValidZip: function(zip,cssselector)
    {
    	if (ShopdataUI.ValidZIP(zip))
		{
            $('#' + cssselector).addClass('ui-autocomplete-loading');
            $.ajax({
                type: "POST",
                url: ShopdataUI.baseURL + 'index.php/main/checkIfValidZip',
                data: {
                    zip: zip
                },
                dataType: 'json',
                success: function (data) {
                    if (data.isValid){
                        $('#invalidZipCodeError').remove();
                        $('#' + cssselector).removeClass('ui-autocomplete-loading');
                        ShopdataUI.zipValid = true;
                        //ShopdataUI.GetZipCodeCords(zip, cssselector);
                    } else {
                        $('#' + cssselector).after('<div id="invalidZipCodeError" class="text-danger"><i class="fa fa-exclamation-triangle"></i> Invalid Zip Code</div>');
                    }
                },
                error: function (data) {
                    shopCartUI.checkIfNetworkError();
                }
            });
		}
    },

    changeTabPanel: function() {
        /* TODO: figure out why tabs won't change properly
        this makes it so the tabs change, I am not sure why but I think there is some sort of conflict between bootstrap and some other plugin.
        Once we figure it out this can be removed.
         */
        $('body').on('click', '.nav-tabs li', function (e) {
            e.preventDefault();
            var target = $(this).data('target');
            $('.tab-content .tab-pane').removeClass('in active');
            $('.nav.nav-tabs li').removeClass('active');
            $('#'+target).addClass('in active');
            $(this).addClass('active');
        })
    },

    GetZipCodeCords: function(zip, cssselector) {
        $.ajax({
            type: "POST",
            url: ShopdataUI.baseURL + 'index.php/main/ajaxGetZipCords',
            data: {
                zip: zip
            },
            dataType: 'json',
            success: function (data) {
                if(data['success'] == true) {
                    $('#'+cssselector).attr('data-ZGLAT', data.results['ZGLAT']);
                    $('#'+cssselector).attr('data-ZGLNG', data.results['ZGLNG']);
                }
            }
        });
    },

    ValidPhone: function(phone)
    {
    	return (phone.trim().match(/^\d{10}(?:[-\s]\d{4})?$/) ? true : false);
    },

    PhoneMaskVal: function(phoneno)
	{
        if(phoneno) {
            var phone = phoneno.toString();
            return (phone == '0'
                    ? ''
                    : (phone.length == 10
                    ? '(' + phone.substr(0, 3) + ') ' + phone.substr(3, 3) + '-' + phone.substr(6, 4)
                    : phone)
            );
        }
	},

    DataListSupport: function()
    {
        var availableTags = $('#popularSearchTerms').find('option').map(function () {
            return this.value;
        }).get();
        $('#txtWord').autocomplete({
            source: availableTags,
            minLength: 0,
            select: function(event, ui) {
                $("#txtWord").val(ui.item.label);
                $("#cmdSearchSKU").trigger(shopCartUI.clickEventToUse);
            }
        }).on('focus', function() {
            $(this).keydown();
        });
    },

    scrollToOpenCustomer: function() {
        try {
            $(".activeCustomer")[0].scrollIntoView(true);
        } catch(e) {

        }
    },
    copyCustomerAddressToShipping: function() {
        var customerFields = ['SDCUSFNAME', 'SDCUSMID', 'SDCUSLNAME', 'SDCUSEMAIL', 'SDCUSPHON1', 'SDCUSADDR1', 'SDCUSADDR2', 'SDCUSCITY', 'SDCUSSTATE', 'SDCUSZIP', 'SDCUSPTYP1'];
        var shippingFields = ['SCSHPFNAME', 'SCSHPMID', 'SCSHPLNAME', 'SCSHPEMAIL', 'SCSHPPHON1', 'SCSHPADDR1', 'SCSHPADDR2', 'SCSHPCITY', 'SCSHPSTATE', 'SCSHPZIP', 'SCSHPPTYP1'];

        ShopdataUI.sync_customer = true;
        for(var i in customerFields) {
            var shippingField = shippingFields[i];
            
            var shippingElem = document.getElementById(shippingFields[i]);
            var customerElem = document.getElementById(customerFields[i]);

            var customerFieldValue = customerElem != null ? customerElem.value.toUpperCase() : '';
            var shippingFieldValue = shippingElem != null ? shippingElem.value.toUpperCase() : '';
           
            if(customerFieldValue != shippingFieldValue) {
                ShopdataUI.sync_customer = false;
            }
        }

        $('body').on('change', '#SCSHPFNAME, #SCSHPMID, #SCSHPLNAME, #SCSHPEMAIL, #SCSHPPHON1, #SCSHPADDR1, #SCSHPADDR2, #SCSHPCITY, #SCSHPSTATE, #SCSHPZIP, #SCSHPPTYP1', function() {
            var elem = $(this);

            setTimeout(function() {
                var customerInfoInput = $(elem).val();
                var id = $(elem).attr('id');
                var fieldIndex = $.inArray(id, shippingFields);

                if($('#'+customerFields[fieldIndex]).val() != customerInfoInput) {
                    ShopdataUI.sync_customer = false;
                }
            }, 800);
            ShopdataUI.checkIfSoldToShipToAreDifferent();
        });

        $('body').on('change', '#SDCUSFNAME, #SDCUSMID, #SDCUSLNAME, #SDCUSEMAIL, #SDCUSPHON1, #SDCUSADDR1, #SDCUSADDR2, #SDCUSCITY, #SDCUSSTATE, #SDCUSZIP', function() {
            var elem = $(this);

            setTimeout(function() {
                if ($('#shippingTab').is(':visible') && ShopdataUI.sync_customer) {
                    var customerInfoInput = $(elem).val();
                    var id = $(elem).attr('id');
                    var fieldIndex = $.inArray(id, customerFields);
                    $('#'+shippingFields[fieldIndex]).val(customerInfoInput).trigger('change');
                }
            }, 600);
        });

        $('body').on(shopCartUI.clickEventToUse, '.SDCUSPTYP1', function() {
            var elem = $(this);
            var phoneType = elem.attr('data-value');
            if(elem.hasClass('SDCUSPTYP1') && ShopdataUI.sync_customer) {
                var custPhone = $('#SDCUSPHON1').val();
                var shipPhone = $('#SCSHPPHON1').val();
                if(custPhone == shipPhone) {
                    $('.SCSHPPTYP1'+phoneType).trigger(shopCartUI.clickEventToUse);
                    $('#SCSHPPTYP1').val(phoneType);
                }
            }
        });
    },

    optInmarketingBoxHander: function() {
        $('body').off('change', '#SDCUSEMAIL, #SCSHPEMAIL').on('change', '#SDCUSEMAIL, #SCSHPEMAIL', function() {      
            // IF CUSTOMER EMAIL IS NOT BLANK OR NONE SHOW CHECKBOX
            $('#SDCUSEMAIL').val() != '' && $('#SDCUSEMAIL').val().toLowerCase() != '*none' 
                ? $('#optInMarkingBox').removeClass('hide') 
                : $('#optInMarkingBox').addClass('hide');

            // IF SHIP EMAIL IS NOT BLANK OR NONE SHOW CHECKBOX
            $('#SCSHPEMAIL').val() != '' && $('#SCSHPEMAIL').val().toLowerCase() != '*none' 
                ? $('#optInMarkingBoxShip').removeClass('hide') 
                : $('#optInMarkingBoxShip').addClass('hide');

            // IF EMAIL ADDRESS MATCH AND ONE OF THEM IS CHECKED SET BOTH OF THEM TO CHECKED
            if($('#SDCUSEMAIL').val().toLowerCase() == $('#SCSHPEMAIL').val().toLowerCase()) {
                var custChecked = $('#CUSTEOPIO').is(':checked');
                var custShipChecked = $('#CUSTSHIPEOPIO').is(':checked');
                if(custChecked || custShipChecked) {
                    $('#CUSTEOPIO').prop('checked', true);
                    $('#CUSTSHIPEOPIO').prop('checked', true);
                }
            }
        });

        $('body').off('click', '#CUSTEOPIO, #CUSTSHIPEOPIO').on('click', '#CUSTEOPIO, #CUSTSHIPEOPIO', function() {
            var elementId = $(this).attr('id');

            // IF CUSTOMER EMAILS MATCH AND ARE NOT EMPTY OR NONE
            if($('#SCSHPEMAIL').val() != '' && $('#SCSHPEMAIL').val().toLowerCase() != '*none' 
                && $('#SCSHPEMAIL').val().toLowerCase() == $('#SDCUSEMAIL').val().toLowerCase()) 
            {
                // SYNC BOXES BASED OFF BOX SELECTED
                if(elementId == 'CUSTEOPIO') {
                    $('#CUSTSHIPEOPIO').prop('checked', $('#'+elementId).is(':checked'));
                } else if(elementId == 'CUSTSHIPEOPIO') {
                    $('#CUSTEOPIO').prop('checked', $('#'+elementId).is(':checked'));
                }
            }

            // IF SDCUSEMAIL IS EMPTY OR *NONE UNCHECK THE OPTIN BOX
            $('#SDCUSEMAIL').val() == '' && $('#SDCUSEMAIL').val().toLowerCase() == '*none' 
                ?  $('#CUSTEOPIO').prop('checked', false) : '';

            // IF SCSHPEMAIL IS EMPTY OR *NONE UNCHECK THE OPTIN BOX
            $('#SCSHPEMAIL').val() == '' && $('#SCSHPEMAIL').val().toLowerCase() == '*none' 
                ?  $('#CUSTSHIPEOPIO').prop('checked', false) : '';
        });
    },

    customerShippingFieldsLock: function() {
        if ($('#shippingTab').is(':visible')) {
            var lockedFields = ['#SCSHPMID', '#SCSHPEMAIL', '#SCSHPADDR2', '#SCSHPCITY', '#SCSHPSTATE', '#SCSHPPHON1'];
            var watchFields = ['#SCSHPFNAME', '#SCSHPLNAME', '#SCSHPZIP', '#SCSHPSTATE', '#SCSHPADDR1'];
            var alertMsg = 'In order to change the locked out fields please change the customer\'s name, address or zip';

            if(ShopdataUI.data.SCCUSTNBR == ShopdataUI.data.SCSHPCSTNR && ShopdataUI.data.SCSHPCSTNR > 0) {
                $('#shipAddress').prepend('<div style="margin-top: 15px;" class="alert alert-warning changeAlert"><i class="fa fa-lock"></i> ' + alertMsg + '</div>');
                $('.copyInfoShipToBox').addClass('hide');
                $('#SCSHPMID, #SCSHPEMAIL, #SCSHPADDR2, #SCSHPCITY, #SCSHPSTATE, #SCSHPPHON1').attr('readonly', true);
                $('#SCSHPSTATE').attr('disabled', true);
                ShopdataUI.changeInputIcon(lockedFields, 'fa fa-lock text-danger lockedInput');
            }

            $('body').on('change', '#SCSHPFNAME, #SCSHPLNAME, #SCSHPZIP, #SCSHPADDR1', function () {
                if(ShopdataUI.data.SCCUSTNBR == ShopdataUI.data.SCSHPCSTNR && ShopdataUI.data.SCSHPCSTNR > 0) {
                    var unlock = false;
                    for (var i in watchFields) {
                        var field = watchFields[i].replace('#', '');
                        var newValue = $(watchFields[i]).val();
                        var oldValue = ShopdataUI.data[field];
                        if (field == 'SCSHPPHON1') {
                            newValue = newValue.replace(/\D/g, '');
                        }

                        if(field.indexOf('zip') !== -1) {
                            if (newValue.toUpperCase() != oldValue.toUpperCase()) {
                                unlock = true;
                            }
                        } else {
                            if (newValue != oldValue) {
                                unlock = true;
                            }
                        }
                    }

                    $('.changeAlert').remove();
                    if (unlock) {
                        ShopdataUI.changeInputIcon(lockedFields, 'fa fa-times-circle clearInput');
                        $('#SCSHPMID, #SCSHPEMAIL, #SCSHPADDR2, #SCSHPCITY, #SCSHPSTATE, #SCSHPPHON1').attr('readonly', false);
                        $('#SCSHPSTATE').attr('disabled', false);
                    } else {
                        ShopdataUI.changeInputIcon(lockedFields, 'fa fa-lock text-danger lockedInput');
                        $('#shipAddress').prepend('<div style="margin-top: 15px;" class="alert alert-warning changeAlert"><i class="fa fa-lock"></i> ' + alertMsg + '</div>');
                        $('#SCSHPMID, #SCSHPEMAIL, #SCSHPADDR2, #SCSHPCITY, #SCSHPSTATE, #SCSHPPHON1').attr('readonly', true);
                        $('#SCSHPSTATE').attr('disabled', true);
                    }
                }
            });
        }
    },

    checkIfSoldToShipToAreDifferent: function() {
        if($('#shippingTab').is(':visible')) {
            var showCopyCheckbox = false;
            var customerFields = ['#SDCUSFNAME', '#SDCUSMID', '#SDCUSLNAME', '#SDCUSEMAIL', '#SDCUSPHON1', '#SDCUSADDR1', '#SDCUSADDR2', '#SDCUSCITY', '#SDCUSSTATE', '#SDCUSZIP', '#SDCUSPTYP1'];
            var shippingFields = ['#SCSHPFNAME', '#SCSHPMID', '#SCSHPLNAME', '#SCSHPEMAIL', '#SCSHPPHON1', '#SCSHPADDR1', '#SCSHPADDR2', '#SCSHPCITY', '#SCSHPSTATE', '#SCSHPZIP', '#SCSHPPTYP1'];

            for (var i in customerFields) {
                if ($(customerFields[i]).val().toUpperCase() != $(shippingFields[i]).val().toUpperCase()) {
                    showCopyCheckbox = true;
                }
            }

            if (showCopyCheckbox) {
                $('#copyCustomerInfoToShipTo input').attr('checked', false);
                $('#customerMenu #warning, .copyInfoShipToBox').removeClass('hide');
            } else {
                $('#customerMenu #warning, .copyInfoShipToBox').addClass('hide');
            }
        }
    },

    copySoldToShipToInputs: function() {
        $('body').on('click', '#copyCustomerInfoToShipTo', function() {
            var customerFields = ['#SDCUSFNAME', '#SDCUSMID', '#SDCUSLNAME', '#SDCUSEMAIL', '#SDCUSPHON1', '#SDCUSADDR1', '#SDCUSADDR2', '#SDCUSCITY', '#SDCUSSTATE', '#SDCUSZIP', '#SDCUSPTYP1'];
            var shippingFields = ['#SCSHPFNAME', '#SCSHPMID', '#SCSHPLNAME', '#SCSHPEMAIL', '#SCSHPPHON1', '#SCSHPADDR1', '#SCSHPADDR2', '#SCSHPCITY', '#SCSHPSTATE', '#SCSHPZIP', '#SCSHPPTYP1'];

            for(var i in customerFields) {
                $(shippingFields[i]).val($(customerFields[i]).val());
                $(shippingFields[i]).trigger('change');
            }

            ShopdataUI.sync_customer = true;
            $('#copyCustomerInfoToShipTo input').prop('checked', false);
        });
    },

    changeInputIcon: function(fields, classes) {
        if(fields.length>0) {
            for(var i in fields) {
                $(fields[i]).closest('.form-group').find('i').attr('class', '').attr('class', classes);
            }
        }
    },

    Customer_Select: function() {
        $('body').on('click', '#customerSearchSelect', function() {
            if($(this).hasClass('splitSaleCart')) {
                var data = $('#splitSaleCustomer').data('customer');
            } else {
                var selection = $("input[name='customer_option']:checked").val();
                var data = $('input[value="' + selection + '"]').closest('tr').data('customer');
            }
            if(data != '') {
                $.ajax({
                    url: ShopdataUI.baseURL + 'index.php/main/Customer_Select',
                    type: 'post',
                    dataType: 'html',
                    data: {customer: data, Shopdata: ShopdataUI.data, GREETING_ID:ShopdataUI.data.SDGREETID},
                    success: function(data) {
                        if (data['SDGREETID'] != 0) {
                            $('#currentCustomerBox').attr('data-customer', data);
                            ShopdataUI.data = data;
                            shopCartUI.updateAppSections('', true);
                            $('#customerInfoArea').addClass('hide').html('');
                            $('#customerLookupWindow').modal('hide');
                            $('#lookupCustomer').removeClass('hide');
                            $('#lookupCustomer').addClass('hide');

                        } else {
                            shopCartUI.displayMsg('The customer data failed to transfer in, please refresh your screen and try again');
                        }
                    },
                    error: function() {
                        shopCartUI.handleCartError();
                    }
                });

            } else {
                $('#customerLookupWindow').modal('hide');
                shopCartUI.displayMsg('The customer data failed to transfer in, please refresh your screen and try again');
            }

        });
    },

    newCustomerSelected: function() {
        $('body').on('click', '#customerSearchNew', function() {
            if(ShopdataUI.data['SDCUSPHON1'] != '' || ShopdataUI.data['SDCUSEMAIL'] != '') {
                ShopdataUI.data = {};
            }
            ShopdataUI.addCustomerInfoFromLookup();
        })
    },
    
    clearSignature: function(){
        var signature = $(this).data('type') == 'hfc' ? 'HFC_SIGNATURE' : 'CUSTOMER_SIGNATURE';
        $('#' + signature).data('jqScribble').clear();
    },
    
    setFurnitureSide: function(){
        $('input[name="FURNITURE_CONFIG"]').val([$(this).data('side')]);
    },
    
    checkAll: function(){
        var checked = $(this).is(':checked'), prefix = $(this).attr('id');
        $.each($("input[id*=" + prefix + "_]"), function(){
            $(this).prop('checked', checked);
        });
    },
    
    checkSelection: function(){
        var unchecked = [], prefix = $(this).attr('id').split('_')[0];
        var optional = ['VERIFY_OPTION_TEXT','VERIFY_RECEIVED_OPTIN_TEXT'];
        $.each($("input[id*=" + prefix + "_]"), function(){
            if ($(this).is(":checked")){
                // do nothing
            } else {
                if (optional.indexOf($(this).attr('id'))==-1){
                    unchecked.push($(this));
                }                
            }
        });
        
        $('#' + prefix).prop('checked', unchecked.length==0);
    },

    openCustomerChecklist: function(){
        var customer = $('#currentCustomerBox').data('customer');
        $.ajax({
            data: {
                GREETING_ID: customer.SDGREETID,
                STORE: customer.SCCARTSTR,
                DELSTORE: ShopdataUI.data.SCDELSTR,
                PUSTORE: ShopdataUI.data.SDPUSTORE,
                INVOICE : ShopdataUI.data.SCSELLINV,
                DELTYPE : ShopdataUI.data.SCDELTYPE,
            },
            type: 'post',
            url: ShopdataUI.baseURL + 'index.php/main/openCustomerChecklist',
            dataType: 'json',
            success: function (response) {
                if(response.success) {
                    $('#customerChecklistArea').html('').html(response.data.view);
                    $('#mainWindow').addClass('hide');
                    $('#customerChecklistArea').removeClass('hide');
                    $('#footer').addClass('hide');
                    $.each(response.data.items, function(key, value){
                        $('#'+key).prop('checked', value=='Y');
                    });
                    
                    $('#INVOICE').val(ShopdataUI.data.SCSELLINV);
                    $('#NOTES').val(response.data.items.NOTES);
                    $('#trackingId').text(ShopdataUI.data.SCTRACKID);
                    $('#trackMyOrder').attr("href", "https://www." + response.data.store.SXWEBSITE + "/track-my-order");
                    $('input:radio[name=FURNITURE_CONFIG]').val([response.data.items.FURNITURE_CONFIG]);
                    $('input:radio[name=SERVICE_SELECTED]').val([response.data.items.SERVICE_SELECTED]);
                    
                    var puStorePhone = '';
                    $.each(ShopdataUI.valuesData.PUSTORES, function(i, row){
                        if ( ShopdataUI.data.SDPUSTORE == row.STRNBR ){
                            puStorePhone = row.PHONE;
                        }
                    });
                    
                    if ( $('#STORE_PHONE').length ){
                        $('#STORE_PHONE').val(response.data.items.hasOwnProperty('STORE_PHONE') ? response.data.items.STORE_PHONE : ShopdataUI.PhoneMaskVal(puStorePhone));
                        $('#STORE_PHONE').css({width: ($('#STORE_PHONE').val().length ) + 'ch'});
                    }
                    
                    if ( $('#HFC_EMAIL').length ){
                        $('#HFC_EMAIL').val(response.data.items.hasOwnProperty('HFC_EMAIL') ? response.data.items.HFC_EMAIL : response.data.user.HEEMAILADR);
                        $('#HFC_EMAIL').css({width: ($('#HFC_EMAIL').val().length + 5 ) + 'ch'});
                    }

                    // Start Customer Signature
                    $('#CUSTOMER_SIGNATURE').jqScribble({
                        brushSize:  2,
                        height: 50,
                        width: 50,
                    });

                    $('#HFC_SIGNATURE').jqScribble({
                        brushSize:  2,
                        height: 50,
                        width: 50,
                    });

                    setTimeout(function(){
                       // Draw the image
                        if ( $("#CUSTOMER_SIGNATURE").length!=0 ){
                            $('#CUSTOMER_SIGNATURE').data('jqScribble').clear();
                            if ( response.data.items.CUSTOMER_SIGNATURE != undefined ){
                                $("#CUSTOMER_SIGNATURE").data("jqScribble").update({backgroundImage: response.data.items.CUSTOMER_SIGNATURE});
                            }
                        }

                        // Draw the image
                        if ( $("#HFC_SIGNATURE").length!=0 ){
                            $('#HFC_SIGNATURE').data('jqScribble').clear();
                            if ( response.data.items.HFC_SIGNATURE != undefined ){
                                $("#HFC_SIGNATURE").data("jqScribble").update({backgroundImage: response.data.items.HFC_SIGNATURE});
                            }
                        } 
                    }, 1);                     

                } else {
                    shopCartUI.handleFailedAjaxCall(response);
                }
            },
            error: function (response) {
                shopCartUI.openModal('modal-md', 'Oops, an error occurred', 'Try refreshing the page and trying again.', 'errorModalWindow');
            }
        });
    },
    
    filterRebates: function() {
        $('body').on('click', '#btnFilterReates', function(e) {
            ShopdataUI.getRebates(e);
        });
    },

    filterOtbCustomers: function() {
        $('body').on('click', '#btnFilterOtbs', function(e) {
            ShopdataUI.getOtbCustomers(e);
        });
    },

    filterChecklists: function() {
        $('body').on('click', '#btnFilterChecklists', function(e) {
            ShopdataUI.getChecklists(e);
        });
    },

    filterCompliance: function() {
        $('body').on('click', '#btnFilterCompliance', function(e) {
            ShopdataUI.getCompliance(e);
        });
    },

    closeManagerChecklist: function() {
        $('body').on('click', '.closeManagerChecklist', function() {
            $('#managerChecklistArea').addClass('hide').html('');
            $('#mainWindow').removeClass('hide');
            window.scrollTo(0, document.body.scrollHeight);
            $('#footer').removeClass('hide');
        });
    },

    closeManagerConnect: function() {
        $('body').on('click', '.closeManagerConnect', function() {
            $('#managerConnectArea').addClass('hide').html('');
            $('#mainWindow').removeClass('hide');
            window.scrollTo(0, document.body.scrollHeight);
            $('#footer').removeClass('hide');
        });
    },
    
    closeManagerRebates: function() {
        $('body').on('click', '.closeManagerRebates', function() {
            $('#managerRebatesArea').addClass('hide').html('');
            $('#mainWindow').removeClass('hide');
            window.scrollTo(0, document.body.scrollHeight);
            $('#footer').removeClass('hide');
        });
    },

    closeManagerOtb: function() {
        $('body').on('click', '.closeManagerOtb', function() {
            $('#managerOtbArea').addClass('hide').html('');
            $('#mainWindow').removeClass('hide');
            window.scrollTo(0, document.body.scrollHeight);
            $('#footer').removeClass('hide');
        });
    },
    
    /* DONE: Split the Wealth */
    getRebates: function(e){
        e.preventDefault();
        let data = {};
        if ($('#hfc').length!=0){
            let inputVal = $('#hfc').val();
            data = {
                empNum : inputVal.split('-')[0],
                hfcno : inputVal.split('-')[1],
            };
        }
        $.ajax({
            data: data,
            type: 'post',
            url: ShopdataUI.baseURL + 'index.php/main/getRebates',
            dataType: 'json',
            success: function (response) {
                if(response.success) {
                    $('#managerRebatesArea').html('').html(response.data.view);
                    $('#mainWindow').addClass('hide');
                    $('#managerRebatesArea').removeClass('hide');
                    $('#footer').addClass('hide');
                } else {
                    shopCartUI.handleFailedAjaxCall(response);
                }
            },
            error: function (response) {
                shopCartUI.openModal('modal-md', 'Oops, an error occurred', 'Try refreshing the page and trying again.', 'errorModalWindow');
            }
        });
    },


    /* DONE: Split the Wealth */
    getOtbCustomers: function(e){
        e.preventDefault();
        let data = {};
        if ($('#hfc').length!=0){
            let inputVal = $('#hfc').val();
            data = {
                empNum : inputVal.split('-')[0],
                hfcno : inputVal.split('-')[1],
            };
        }
        $.ajax({
            data: data,
            type: 'post',
            url: ShopdataUI.baseURL + 'index.php/main/getOtbCustomers',
            dataType: 'json',
            success: function (response) {
                if(response.success) {
                    $('#managerOtbArea').html('').html(response.data.view);
                    $('#mainWindow').addClass('hide');
                    $('#managerOtbArea').removeClass('hide');
                    $('#footer').addClass('hide');
                } else {
                    shopCartUI.handleFailedAjaxCall(response);
                }
            },
            error: function (response) {
                shopCartUI.openModal('modal-md', 'Oops, an error occurred', 'Try refreshing the page and trying again.', 'errorModalWindow');
            }
        });
    },

    getChecklists: function(e){
        e.preventDefault();
        let data = {};
        if ($('#hfcno').length!=0){
            let inputVal = $('#hfcno').val();
            data = {
                empNum : inputVal.split('-')[0],
                hfcno : inputVal.split('-')[1],
                year: $('#year').val(),
                month: $('#month').val(),
                day: $('#day').val()
            };
        }

        $.ajax({
            data: data,
            type: 'post',
            url: ShopdataUI.baseURL + 'index.php/main/getChecklists',
            dataType: 'json',
            success: function (response) {
                if(response.success) {
                    $('#managerChecklistArea').html('').html(response.data.view);
                    $('#mainWindow').addClass('hide');
                    $('#managerChecklistArea').removeClass('hide');
                    $('#footer').addClass('hide');
                } else {
                    shopCartUI.handleFailedAjaxCall(response);
                }
            },
            error: function (response) {
                shopCartUI.openModal('modal-md', 'Oops, an error occurred', 'Try refreshing the page and trying again.', 'errorModalWindow');
            }
        });
    },

    /* DONE: Split the Wealth */
    getCompliance: function(e){
        e.preventDefault();
        let data = {};
        if ($('#hfcno').length!=0){
            let inputVal = $('#hfcno').val();
            data = {
                empNum : inputVal.split('-')[0],
                hfcno : inputVal.split('-')[1],
                year: $('#year').val(),
                month: $('#month').val(),
                day: $('#day').val()
            };
        }

        $.ajax({
            data: data,
            type: 'post',
            url: ShopdataUI.baseURL + 'index.php/main/getCompliance',
            dataType: 'json',
            success: function (response) {
                if(response.success) {
                    $('#managerChecklistArea').html('').html(response.data.view);
                    $('#mainWindow').addClass('hide');
                    $('#managerChecklistArea').removeClass('hide');
                    $('#footer').addClass('hide');
                } else {
                    shopCartUI.handleFailedAjaxCall(response);
                }
            },
            error: function (response) {
                shopCartUI.openModal('modal-md', 'Oops, an error occurred', 'Try refreshing the page and trying again.', 'errorModalWindow');
            }
        });
    },

    managerItems: function(e){
        var item = $(this).val();
        switch(item) {
            case 'customers_connect':
                SalesUp.getConnectHFCs({});
                break;
            case 'checklists':
                ShopdataUI.getChecklists(e);
                break;
            case 'compliance':
                ShopdataUI.getCompliance(e);
                break;
            case 'otb':
                ShopdataUI.getOtbCustomers(e);
                break;
            case 'rebates':
                ShopdataUI.getRebates(e);
                break;
            default:
                // code block
        }
        $(this).val('goto');
    },

    saveCustomerChecklist: function(){
        var items = {}, ready = false, signed = false;
        var save = function(items, dataCustomerURL, dataHFCURL){
            $.ajax({
                data: {
                    GREETING_ID: ShopdataUI.data.SDGREETID,
                    STORE: ShopdataUI.data.SCCARTSTR,
                    INVOICE : ShopdataUI.data.SCSELLINV,
                    DELTYPE : ShopdataUI.data.SCDELTYPE,
                    ITEMS : JSON.stringify(items),
                    imageDataCustomer : dataCustomerURL!='' ? dataCustomerURL.substr(dataCustomerURL.indexOf(',')+1) : '',
                    imageDataHFC : dataHFCURL!='' ? dataHFCURL.substr(dataHFCURL.indexOf(',')+1) : '',
                },
                type: 'post',
                url: ShopdataUI.baseURL + 'index.php/main/saveCustomerChecklist',
                dataType: 'json',
                success: function (data) {
                    ShopdataUI.closeCustomerChecklist();
                    shopCartUI.openModal('modal-md', 'Information', 'Customer checklist saved.', 'errorModalWindow');
                },
                error: function (data) {
                    shopCartUI.openModal('modal-md', 'Oops, an error occurred', 'Try refreshing the page and trying again.', 'errorModalWindow');
                }
            });
        };
        items['INVOICE'] = ShopdataUI.data.SCSELLINV;
        items['NOTES'] = $('#NOTES').val();
        items['CUSTOMER_SIGNATURE'] = ShopdataUI.data.SCCARTSTR + '_' + ShopdataUI.data.SCSELLINV + '_customer_signature.png';
        items['FURNITURE_CONFIG'] = $('input[name="FURNITURE_CONFIG"]:checked').val();
        if ($("input[name='SERVICE_SELECTED']").length){
            items['SERVICE_SELECTED'] = $('input[name="SERVICE_SELECTED"]:checked').val();
        }
        if ($('#STORE_PHONE').length){
            items['STORE_PHONE'] = $('#STORE_PHONE').val();
        }
        if ($('#HFC_EMAIL').length){
            items['HFC_EMAIL'] = $('#HFC_EMAIL').val();
        }
        if ($('#HFC_SIGNATURE').length){
            items['HFC_SIGNATURE'] = ShopdataUI.data.SCCARTSTR + '_' + ShopdataUI.data.SCSELLINV + '_hfc_signature.png';
        }
        $.each($(".checklist-table").find(':checkbox'), function(){
            items[$(this).attr('id')] = $(this).is(':checked') ? 'Y' : 'N';
        });       

        ready = ($('#SERVICE').length==0 || ($('#SERVICE').length!=0 && $('#SERVICE').is(":checked")))
                && $('#VERIFY').is(":checked") 
                && $('#PROCESS').is(":checked") 
                && ($('input[name="FURNITURE_CONFIG"]:checked').val()!=undefined)
                && ($('input[name="SERVICE_SELECTED"]').length==0 || ($('input[name="SERVICE_SELECTED"]').length!=0 && $('input[name="SERVICE_SELECTED"]:checked').val()!=undefined));
        
        
        signed = !$('#CUSTOMER_SIGNATURE').data('jqScribble').blank;
        if ( $('#HFC_SIGNATURE').length!=0 ){
            signed = signed && !$('#HFC_SIGNATURE').data('jqScribble').blank;
        }

        if ( signed ){
            if (ready){
                if ( $('#HFC_SIGNATURE').length!=0 ){
                    $('#CUSTOMER_SIGNATURE').data('jqScribble').save(function(dataCustomerURL){
                        $('#HFC_SIGNATURE').data('jqScribble').save(function(dataHFCURL){
                            save(items, dataCustomerURL, dataHFCURL);
                        });
                    });
                } else {
                    $('#CUSTOMER_SIGNATURE').data('jqScribble').save(function(dataCustomerURL){
                        save(items, dataCustomerURL, '');
                    });
                }
                
            } else {
                shopCartUI.openModal('modal-md', 'Oops!', 'Please check all items before saving the checklist.', 'errorModalWindow');
            }
        } else {
            shopCartUI.openModal('modal-md', 'Oops!', 'Please sign the checklist first.', 'errorModalWindow');
        }
    },
    
    closeCustomerChecklist: function() {
        shopCartUI.showMainWindow();
        $('#customerChecklistArea').addClass('hide').html('');
        $('#footer').removeClass('hide');
    },

    /* NEW FUNCTIONALITY REFACTORING THE CUSTOMER INFO STUFF */
    // IF YOU WANT TO SHOW THE LOOK UP BOX SET ShopdataUI.showLookupBox = true. Note: email and/or phone must be empty as well
    openCustomerInfoPage: function(showLookUp) {
        $('#customerInfoArea').html('');
        var customer = $('#currentCustomerBox').data('customer');
        if(customer.CUSTCNTPH == '' && customer.SDCUSEMAIL == '') {
            showLookUp = true;
        } else {
            showLookUp = false;
        }
        var emailAddress = ShopdataUI.customerLookup.email;

        if(customer) {
            $.ajax({
                data: {
                    CUSTLOOKUP: showLookUp,
                    PHONE: ShopdataUI.customerLookup.phone,
                    EMAIL: ShopdataUI.customerLookup.email,
                    GREETING_ID: customer.SDGREETID,
                },
                type: 'post',
                url: ShopdataUI.baseURL + 'index.php/main/customerInformationEdit',
                dataType: 'json',
                success: function (data) {
                    if(data.success) {
                        ShopdataUI.data = $('#currentCustomerBox').data('customer');

                        $('#customerInfoArea').html(data.data.view);
                        $('#mainWindow').addClass('hide');

                        if (ShopdataUI.data) {
                            $('#customerInfoArea').removeClass('hide');

                            var phoneFields = ['SDCUSPHON1', 'SDCUSPHON2', 'SCSHPPHON1', 'SCSHPPHON2'];
                            for (var i in phoneFields) {
                                if ($('#' + phoneFields[i]).length > 0) {
                                    $('#' + phoneFields[i]).val(ShopdataUI.PhoneMaskVal($('#' + phoneFields[i]).val()));
                                }
                            }

                            var FutureOnly = {minDate: new Date(), closeText: "Close", showButtonPanel: true}
                            if ($('#SDLASTDATE').length > 0 && typeof ShopdataUI.data['SDLASTDATE'] != 'undefined') {
                                $('#SDLASTDATE').val(ShopdataUI.datePickerFromAS400(ShopdataUI.data.SDLASTDATE));
                            }
                            if ($('#SDWANTDATE').length > 0 && typeof ShopdataUI.data['SDLASTDATE'] != 'undefined') {
                                $('#SDWANTDATE').val(ShopdataUI.datePickerFromAS400(ShopdataUI.data.SDWANTDATE));
                            }

                            $('#SDWANTDATE, #SDLASTDATE, #LSDWANTDATE, #LSDLASTDATE').on('focus', function () {
                                $(this).blur();
                            }).datepicker(FutureOnly);

                            ShopdataUI.initClearable();

                            $('#SCSHPPHON1, #SCSHPPHON2, #SDCUSPHON1, #SDCUSPHON2, #LSDCUSPHON1, #CUSTCNTPH, #SDCUSPHON1SEARCH').mask('(000) 000-0000');

                            $('#customerInfoArea').removeClass(data);
                            ShopdataUI.copyCustomerAddressToShipping();
                            ShopdataUI.initMultiSelect();
                            if (ShopdataUI.isCartReadOnly) {
                                $('.saveCustomerInfo').remove();
                            }

                            shopCartUI.switchPrimaryContact();
                            ShopdataUI.watchForShippingAddressChanges();
                            ShopdataUI.copySoldToShipToInputs();
                            shopCartUI.textOptInHandler();
                            shopCartUI.sendCustomerOptinMessage();
                            shopCartUI.customerOptOutTextMessage();

                            ShopdataUI.setPhoneTypeOnButtonClick();
                            ShopdataUI.customerShippingFieldsLock();
                            ShopdataUI.checkIfSoldToShipToAreDifferent();
                            ShopdataUI.optInmarketingBoxHander();
                            ShopdataUI.toggleCustomerOptionInput();

                            if (typeof ShopdataUI.data.SCCARTID != 'undefined' && ShopdataUI.data.SCCARTID > 0) {
                                //     $('.primaryLabelInput').removeClass('hide');
                                //     $('#robocalls').removeClass('hide');
                                $('.addAdditionalPhone').removeClass('hide');
                            }
                            if(typeof ShopdataUI.data.CUSTOMER_OPTION != 'undefined'
                                && ShopdataUI.data.CUSTOMER_OPTION == 'Y') {
                                {
                                    $('#CUSTOMER_OPTION').attr('checked', true);
                                    $('#CUSTOMER_OPTION_SELECTION').val(ShopdataUI.data.CUSTOMER_OPTION_SELECTION);
                                    if(ShopdataUI.data.CUSTOMER_OPTION_ADDITIONAL_INPUT != '') {
                                        $('#CUSTOMER_OPTION_ADD_OPTION').attr('checked', true);
                                    }
                                }
                            }
                            $('#footer').addClass('hide');
                        } else {
                            $('#customerInfoArea').html('');
                            $('#mainWindow').removeClass('hide');
                            shopCartUI.openModal('modal-md', 'Oops, an error occurred', 'There was an error pulling up the customers information. Try refreshing the page and trying again. If the problem persists contact support and let them know what you were doing and the customer you were clicking on and we will look into it.', 'errorModalWindow');
                        }
                    } else {
                        shopCartUI.handleFailedAjaxCall(data);
                    }
                },
                error: function (data) {
                    shopCartUI.openModal('modal-md', 'Oops, an error occurred', 'There was an error pulling up the customers information. Try refreshing the page and trying again. If the problem persists contact support and let them know what you were doing and the customer you were clicking on and we will look into it.', 'errorModalWindow');
                }
            });
            ShopdataUI.customerLookup = {};
        } else {
            shopCartUI.openModal('modal-md', 'Oops, an error occurred', 'You must first select or engage a customer before going into customer information.', 'errorModalWindow');
        }
    },

    closeCustomerInfoPage: function() {
        $('body').on('click', '.closeCustomerInfoPage', function() {
            $('#customerInfoWarning').modal('hide');
            $('#customerInfoArea').addClass('hide').html('');
            $('#mainWindow').removeClass('hide');
            window.scrollTo(0, document.body.scrollHeight);
            $('#footer').removeClass('hide');
            ShopdataUI.destroyCustomerInfo();
            $('body').off('click', '#CUSTOMER_OPTION');
        });
    },

    checkForChangeCustomerInfo: function(e) {
        if (ShopdataUI.isCustomerInfoChanged()
            && !ShopdataUI.isManager
            && !ShopdataUI.isCartReadOnly
            && !ShopdataUI.isLookup
            && $('.saveCustomerInfo').length > 0)
        {
            var btns = [
                {
                    id: 'saveCustomerInfoButton',
                    name: 'Save',
                    class: 'btn btn-default saveCustomerInfo',
                },
                {
                    id: 'discardCustomerInfo',
                    name: 'Discard',
                    class: 'btn btn-default closeCustomerInfoPage',
                },
                {
                    id: 'closeCurrentModal',
                    name: 'Return',
                    class: 'btn btn-default',
                    data: 'data-dismiss="modal"',
                },
            ];
            shopCartUI.openModal('modal-md', 'Warning', 'You are about to leave the Customer Information page without saving', 'customerInfoWarning', btns, true)
        } else {
            shopCartUI.showMainWindow()
            ShopdataUI.destroyCustomerInfo();
            $('#customerInfoArea').addClass('hide').html('');
        }
    },

    lookUpCustomer: function() {
        $('body').on('click', '#searchExistingCustomer', function(event) {
            event.preventDefault();
            $('#lookUpError').remove();

            var loadModalSameWindow = false;
            var modalId = '';
            if($(this).hasClass('sameWindow')) {
                loadModalSameWindow = true;
                modalId = $(this).closest('.modal').attr('id');
            }

            ShopdataUI.lookupSameCustomer = true;

            ShopdataUI.data.CUSTOMER_OPTION = $('#CUSTOMER_OPTION').is(':CHECKED') ? 'Y' : 'N';
            ShopdataUI.data.CUSTOMER_OPTION_ADDITIONAL_INPUT = $('#CUSTOMER_OPTION_ADD_OPTION').val();
            ShopdataUI.data.CUSTOMER_OPTION_SELECTION = $('#CUSTOMER_OPTION_SELECTION').val();

            var email = $("#SDCUSEMAILSEARCH").val();
            var phone = $("#SDCUSPHON1SEARCH").val();
            var ezpass = typeof $("#SDCUSEASYPASSSEARCH").val() == 'undefined' ? '' : $("#SDCUSEASYPASSSEARCH").val();
            var lookup = true;

            if(email == '' && phone == '' && ezpass == '') {
                $('#searchExistingCustomer').before('<div id="lookUpError" class="alert alert-danger"><i class="fa fa-exclamation-triangle"></i> Email, Phone number or Easypass is required</div>');
            } else {
                if(email) {
                    email = email.toUpperCase();
                }
                if(phone) {
                    if(phone.length != 14) {
                        $('#searchExistingCustomer').before('<div id="lookUpError" class="alert alert-danger"><i class="fa fa-exclamation-triangle"></i> Invalid Phone number</div>');
                        lookup = false;
                    }
                }

                if(lookup) {
                    var input = {
                        email: email,
                        phone: phone,
                        easypass: ezpass,
                        lookup: loadModalSameWindow,
                        GREETING_ID: ShopdataUI.data.SDGREETID,
                    }

                    $.ajax({
                        url: shopCartUI.baseURL + 'index.php/main/ShopData_LookupCustomer',
                        data: input,
                        type: 'post',
                        dataType: 'json',
                        success: function (data) {
                            if(data.success) {
                                ShopdataUI.customerLookup.phone = phone;
                                ShopdataUI.customerLookup.email = email;
                                if (loadModalSameWindow) {
                                    $('#' + modalId + ' .modal-body').html(data.data.view);
                                } else {
                                    shopCartUI.openModal('modal-lg', '<i class="fa fa-search"></i> Search Results', data.data.view, 'customerLookupWindow');
                                }
                            } else {
                                shopCartUI.handleFailedAjaxCall(data);
                            }
                        },
                        error: function(data) {
                            shopCartUI.handleCartError(data);
                        }
                    });
                }
            }
        });
    },

    closingCustomerLookupWindow: function() {
        $(document).on('click','#customerLookupWindow .close, #customerLookupWindow #closeModalWindow',function(){
            ShopdataUI.customerLookup.phone = '';
            ShopdataUI.customerLookup.email = ''
        });
    },

    customerAddressLookup: function() {
        $('body').on('focusout', '#SDCUSADDR1, #SCSHPADDR1', function() {
            setTimeout(function() {
                $('.addresssLookupBox').remove();
                if($('#SDCUSADDR1').val() != '') {
                    //$('.primaryLabelInput').removeClass('hide');
                    //$('#robocalls').removeClass('hide');
                    //$('.addAdditionalPhone').removeClass('hide');
                } else {
                    //$('.primaryLabelInput').addClass('hide');
                    //$('#robocalls').addClass('hide');
                    //$('.addAdditionalPhone').addClass('hide');
                }
            }, 200)
        });

        $('body').on('keyup', '#SDCUSADDR1, #SCSHPADDR1', function() {
            var id = $(this).attr('id');
            delay(function(){
                $('.addresssLookupBox').remove();
                if(id == 'SDCUSADDR1') {
                    var zip = $('#SDCUSZIP').val();
                    var addr = $('#SDCUSADDR1').val();
                } else {
                    var zip = $('#SCSHPZIP').val();
                    var addr = $('#SCSHPADDR1').val();
                }
                $.ajax({
                    global: false,
                    url: ShopdataUI.baseURL+'index.php/main/ShopData_AddressAutocomplete',
                    type: 'post',
                    dataType: 'json',
                    data: {zip: zip, addr: addr},
                    success: function(addresses) {
                        if(typeof addresses.CITY != 'undefined') {
                            var address_line = '<ul class="addresssLookupBox">';
                            for(var i in addresses.CITY) {
                                if(i<10) {
                                    address_line += '<li data-address="' + addresses.STREET[i] + '" data-city="' + addresses.CITY[i] + '" data-state="' + addresses.STATE[i] + '"><i class="fa fa-map-marker"></i> ' + addresses.STREET[i] + ', ' + addresses.CITY[i] + ', ' + addresses.STATE[i] + '</li>';
                                }
                            }
                            address_line += '</ul>';
                            $('#'+id).parent().after(address_line);
                        }
                    },
                });
            }, ShopdataUI.addressSearchWaitTime);
        });

        var delay = (function(){
            var timer = 0;
            return function(callback, ms){
                clearTimeout (timer);
                timer = setTimeout(callback, ms);
            };
        })();
    },

    customerAddressLookupSelection: function() {
        $('body').on('click', '.addresssLookupBox li', function() {
            var address = $(this).data('address');
            var city = $(this).data('city');
            var state = $(this).data('state');
            var id = $(this).parent().parent().find('input').attr('id');
            if(id == 'SDCUSADDR1') {
                $('#SDCUSADDR1').val(address);
                $('#SDCUSCITY').val(city);
                $('#SDCUSSTATE').val(state);
                setTimeout(function() {
                    $('#SDCUSADDR1').trigger('change');
                    $('#SDCUSCITY').trigger('change');
                    $('#SDCUSSTATE').trigger('change');
                }, 350);
            } else {
                $('#SCSHPADDR1').val(address);
                $('#SCSHPCITY').val(city);
                $('#SCSHPSTATE').val(state);
            }
            $('.addresssLookupBox').remove();

        });
    },

    loadRelatedSKUDates: function() {
        $('body').on('click', '.viewRelatedSkuDates', function() {
            var sku = $(this).attr('data-sku');
            var elem = $(this);
            $.ajax({
                url: ShopdataUI.baseURL+'index.php/main/loadRelatedDates',
                data: {'sku': sku},
                dataType: 'json',
                type: 'post',
                success: function(data) {
                    if(data.success) {
                        elem.removeClass('viewRelatedSkuDates');

                        $('#datesSection-' + sku+' .list-group').html(data.page);
                        $('#datesSection-' + sku).addClass('in');
                        elem.find('.fa-caret-down').remove();
                        var pickUpDate = $('#datesSection-'+sku).find('.pickupDate').attr('data-date');
                        if(pickUpDate != '' && $('[data-target="#datesSection'+sku+'"]').html().indexOf('Not') !== -1) {
                           $('[data-target="#datesSection'+sku+'"]').html('Available');
                        }
                    } else {
                        shopCartUI.displayMsg(data.msg);
                    }
                },
                error: function () {
                    shopCartUI.displayMsg('Failed to load the dates, please try refreshing the page and trying again');
                }
            })
        });
    },
    
    purePromiseRebate: function() {
        $('#purePromiseRebate').click(function() {
            ShopdataUI.openPurePromiseRebate();
            shopCartUI.CloseSideMenu();
        });
    },

    whatIfCalculator: function() {
        $('#menuWhatIfCalculator').click(function() {
            ShopdataUI.openWhatIfCalculator();
            shopCartUI.CloseSideMenu();
        });
    },

    openWhatIfCalculator: function(optionalMessage) {
        $.ajax({
            type: "POST",
            url: shopCartUI.baseURL + 'index.php/main/load_whatifcalc',
            dataType: 'json',
            success: function (response) {
                if(response.success) {
                    var buttons = [{}];
                    $('#whatIfCalcWindow').remove();
                    shopCartUI.openModal('modal-lg', '<i class="fa fa-calculator fa-fw"></i> What If Calculator', response.data.view, 'whatIfCalcWindow', buttons);
                    PurePromise.init();
                } else {
                    alert('Error pulling in the view, try again. If the problem persists please contact support.');
                }
            },
            error: function () {
                alert('Error pulling in the view, try again. If the problem persists please contact support.');
            }
        });
    },
    
    openPurePromiseRebate: function(optionalMessage) {
        $.ajax({
            type: "POST",
            url: shopCartUI.baseURL + 'index.php/main/load_ppr',
            dataType: 'json',
            success: function (response) {
                if(response.success) {
                    var buttons = [{}];
                    $('#pprWindow').remove();
                    shopCartUI.openModal('modal-lg', '<i class="fa fa-credit-card fa-fw"></i> Pure Promise Rebate', response.data.view, 'pprWindow', buttons);
                    ShopdataUI.initPurePromiseRebateTable();
                } else {
                    alert('Error pulling in the view, try again. If the problem persists please contact support.');
                }
            },
            error: function () {
                alert('Error pulling in the view, try again. If the problem persists please contact support.');
            }
        });
    },
    
    rebateDetails: function() {
        $('body').on(shopCartUI.clickEventToUse, '.rebate-details', function(event) {
            event.preventDefault();
            $.ajax({
                type: "POST",
                data: $(this).data(),
                url: shopCartUI.baseURL + 'index.php/main/ppr_details',
                dataType: 'json',
                success: function (response) {
                    if(response.success) {
                        var buttons = [{}];
                        shopCartUI.openModal('modal-md', '<i class="fa fa-credit-card fa-fw"></i> Pure Promise Rebate Details', response.data.view, 'pprDetailsWindow', buttons);
                    } else {
                        shopCartUI.handleFailedFormSubmission(response.data);
                    }
                }
            });
        });
    },
    
    doAssignRebate: function() {
        $('body').on('click', '#doAssignRebate', function(event) {
            $.ajax({
                type: "POST",
                data: $('#assignHfcForm').serialize(),
                url: shopCartUI.baseURL + 'index.php/main/do_assign',
                dataType: 'json',
                success: function (response) {
                    if(response.success) {
                        var table = $('#datatables').DataTable(),
                            refs = JSON.parse(response.data.refs);
                        refs.forEach(function(ref){ 
                            var rowId = '#row-' + ref;
                            var rowData = table.row(rowId).data();
                            rowData[0] = '';
                            rowData[1] = response.data.hfcId.split('-')[1];
                            table.row(rowId).data(rowData).draw(); 
                        }); 
                        $('#pprAssignWindow').modal('hide');
                    } else {
                        shopCartUI.handleFailedFormSubmission(response.data);
                    }
                }
            });
        });
    },
    
    doRebateContacted: function() {
        $('body').on('click', '#doRebateContacted', function(event) {
            var btn = $(this);
            $('#pprConfirmWindow').modal('hide');
            $.ajax({
                type: "POST",
                data: btn.data(),
                url: shopCartUI.baseURL + 'index.php/main/ppr_contact',
                dataType: 'json',
                success: function (response) {
                    if(response.success) {
                        $('#check-' + btn.data('ref'))
                           .prop('checked', true)
                           .prop('disabled', true);
                    } else {
                        shopCartUI.handleFailedFormSubmission(response.data);
                    }
                }
            });
        });
    },
    
    contactRebate: function() {
        $('body').on(shopCartUI.clickEventToUse, '.customer-contacted', function(event) {
            event.preventDefault();
            var html = "Did you contact the customer?";
            var buttons = [
                {
                    id: 'doRebateContacted',
                    name: 'Yes',
                    class: 'btn btn-danger',
                    data: "data-ref='" + $(this).data('ref') + "'",
                },
            ];
            shopCartUI.openModal('modal-md', '<i class="fa fa-credit-card fa-fw"></i> Pure Promise Rebate', html, 'pprConfirmWindow', buttons);
        });
    },
    
    rebateSummary: function() {
        $('body').on(shopCartUI.clickEventToUse, '#btnRebatesReport', function(event) {
            event.preventDefault();
            $.ajax({
                type: "POST",
                url: shopCartUI.baseURL + 'index.php/main/rebates_summary',
                dataType: 'json',
                success: function (response) {
                    if(response.success) {
                        var buttons = [];
                        shopCartUI.openModal('modal-lg', '<i class="fa fa-credit-card fa-fw"></i> Pure Promise Rebate', response.data.view, 'pprSummaryWindow', buttons);
                        ShopdataUI.initSummaryRebateTable();
                    } else {
                        alert('Error pulling in the view, try again. If the problem persists please contact support.');
                    }
                },
                error: function () {
                    alert('Error pulling in the view, try again. If the problem persists please contact support.');
                }
            });
        });
    },
    
    selectHFCRebates: function() {
        $('body').on(shopCartUI.clickEventToUse, '.view-rebates', function(event) {
            event.preventDefault();
            var hfcname = $(this).data('hfcname'), table = $('#datatables').DataTable();
            $('#pprSummaryWindow').modal('hide');
            table.page.len(-1).draw();
            table.search(hfcname).draw();
            $.each($('.assign-rebate'), function(){
                $(this).prop('checked', true);
            });
        });
    },
    
    assignRebate: function() {
        $('body').on(shopCartUI.clickEventToUse, '#btnAssignRebate', function(event) {
            event.preventDefault();
            var refs = [];
            $('.assign-rebate').each(function(){
                if ($(this).prop('checked')){
                    refs.push($(this).data('ref'));
                }
            });

            if (refs.length==0){
                var html = "Please select rebates to assign.",
                    buttons = [];
                shopCartUI.openModal('modal-md', '<i class="fa fa-credit-card fa-fw"></i> Pure Promise Rebate', html, 'ppr2ConfirmWindow', buttons);
            } else {
                $.ajax({
                    type: "POST",
                    data: {refs: JSON.stringify(refs)},
                    url: shopCartUI.baseURL + 'index.php/main/load_assign',
                    dataType: 'json',
                    success: function (response) {
                        if(response.success) {
                            var buttons = [
                                {
                                    id: 'doAssignRebate',
                                    name: 'Assign HFC',
                                    class: 'btn btn-danger',
                                    data: '',
                                },
                            ];
                            shopCartUI.openModal('modal-md', '<i class="fa fa-credit-card fa-fw"></i> Pure Promise Rebate', response.data.view, 'pprAssignWindow', buttons);
                        } else {
                            alert('Error pulling in the view, try again. If the problem persists please contact support.');
                        }
                    },
                    error: function () {
                        alert('Error pulling in the view, try again. If the problem persists please contact support.');
                    }
                });
            }
        });
    }, 
    
    initPurePromiseRebateTable: function() {
        $(document).ready(function(){
            var searchBox = $('#hdnSearchBox').val();
            var table = $('#tblRebatesList').DataTable({
                destroy: true,
                bStateSave: false,
                bProcessing: true,
                bPaginate: true,
                bInfo: true,
                bDeferRender: true,
                scrollY: "300px",
                lengthMenu: [ [10, 25, 50, 100, 150, 200, 500, -1], [10, 25, 50, 100, 150, 200, 500, "All"] ],
                pageLength: 10,
                oSearch: {"sSearch": searchBox},
                order: [],
                aaSorting: [],
                aoColumnDefs:
                [
                   {"aTargets":[0]},
                   {"aTargets":[1]},
                   {"aTargets":[2]},
                   {"aTargets":[3]},
                   {"aTargets":[4]},
                ],
            });
        });
    },
    
    initSummaryRebateTable: function() {
        $(document).ready(function(){
            var searchBox = $('#hdnSearchBox').val();
            var table = $('#tblRebatesReport').DataTable({
                destroy: true,
                bStateSave: false,
                bProcessing: true,
                bPaginate: true,
                bInfo: true,
                bDeferRender: true,
                scrollY: "300px",
                lengthMenu: [ [10, 25, 50, 100, 150, 200, 500, -1], [10, 25, 50, 100, 150, 200, 500, "All"] ],
                pageLength: 10,
                oSearch: {"sSearch": searchBox},
                order: [],
                aaSorting: [],
                aoColumnDefs:
                [
                   {"aTargets":[0]},
                   {"aTargets":[1]},
                   {"aTargets":[2]},
                ],
            });
        });
    },
    
    finance: function() {
        $('#finance').click(function() {
            ShopdataUI.openFinance();
            shopCartUI.CloseSideMenu();
        });
    },
    
    openFinance: function(optionalMessage) {
        $.ajax({
            type: "POST",
            data: {optional_message: optionalMessage},
            url: shopCartUI.baseURL + 'index.php/main/load_finance',
            dataType: 'json',
            success: function (data) {
                if(data.success) {
                    var buttons = [
                        {
                            id: 'doFinance',
                            name: 'Generate QR Code',
                            class: 'btn btn-danger',
                            data: '',
                        },
                    ];
                    shopCartUI.openModal('modal-md', '<i class="fa fa-money fa-fw"></i> Finance Application', data.data.view, 'financeWindow', buttons);
                    $("#applicationType1").prop("checked", true);
                } else {
                    alert('Error pulling in the view, try again. If the problem persists please contact support.');
                }
            },
            error: function () {
                alert('Error pulling in the view, try again. If the problem persists please contact support.');
            }
        });
    },
    
    doFinance: function() {
        $('body').on('click', '#doFinance', function(event) {
            event.preventDefault();
            var formData = $('#financeForm').serialize();
            $.ajax({
                type: "POST",
                data: formData,
                url: shopCartUI.baseURL + 'index.php/main/do_finance',
                dataType: 'json',
                success: function (response) {
                    if(response.success) {
                        var html = '';
                            html += '<div class="form-group text-center">';
                            if (response.data.path==""){
                                html += 'There is an error generating the QR code, please contact support.';
                            } else {
                                html += '<img src="index.php/main/photo?path=' + response.data.path + '" style="width: 100%;" />';
                            }
                            html += '</div>';
                        var addButton = [{}];
                        $('#financeWindow').modal('hide');
                        shopCartUI.openModal('modal-md', '<i class="fa fa-money fa-fw"></i> Finance Application - ' + response.data.type, html, 'financeQRC',addButton);
                        // Close the QR code to avoid HFCs reusing used code, wait for 3 minutes 
                        setInterval(function(){ $('#financeQRC').modal('hide'); }, 180000);
                    } else {
                        ShopdataUI.handleFailedFormSubmission(response.data);
                    }
                },
                error: function () {
                    alert('Error pulling in the view, try again. If the problem persists please contact support.');
                }
            });
        });
    },
	
	doProgressive: function() {
        $('body').on('click', '#doProgressive', function(event) {
            event.preventDefault();
            $.ajax({
                type: "POST",
                url: shopCartUI.baseURL + 'index.php/main/do_progressive',
                dataType: 'json',
                success: function (response) {
                    if(response.success) {
                        var html = '';
                            html += '<div class="form-group text-center">';
                            if (response.data.path==""){
                                html += 'There is an error generating the QR code, please contact support.';
                            } else {
                                html += '<img src="index.php/main/photo?path=' + response.data.path + '" style="width: 100%;" />';
                            }
                            html += '</div>';
                        var addButton = [{}];
                        //$('#financeWindow').modal('hide');
                        shopCartUI.openModal('modal-md', '<i class="fa fa-money fa-fw"></i> Lease with Progressive', html, 'progressiveQRC',addButton);
                        // Close the QR code to avoid HFCs reusing used code, wait for 3 minutes 
                        //setInterval(function(){ $('#progressiveQRC').modal('hide'); }, 180000);
                    } else {
                        ShopdataUI.handleFailedFormSubmission(response.data);
                    }
                },
                error: function () {
                    alert('Error pulling in the view, try again. If the problem persists please contact support.');
                }
            });
        });
    },

    enterCustomerEmail: function() {
        $('#customerEmail').click(function() {
            var html = '<div class="row">';
            html += '<div class="col-md-10 col-md-offset-1">';
            html += '<br><label style="font-size:1em">Email:</label>';
            html += '<div class="input-group">';
            html += '<input type="text" id="customerEmailInput" class="form-control input-md">';
            html += '<span class="input-group-btn">';
            html += '<button id="saveCustomerEmailInput" class="btn btn-default btn-md" type="button">Save</button>';
            html += '</span>';
            html += '</div>';
            html += '<div id="optInMarkingBox" class="">';
            html += '<div class="checkbox">';
            html += '<label class="control-label">';
            html += '<input type="checkbox" id="marketingMaterialOptIn" checked required /> <span class="text-danger">*</span> Opt-in to receive promotion and marketing emails?';
            html += '</label></div></div>';
            html += '<div id="emailFeedback"></div>';
            html += '</div>';
            html += '</div>';
            html += '<div style="height:30px;"></div>';
            shopCartUI.openModal('modal-md', 'Enter Customer\'s Email', html, 'customerEmailWindow', {});
            shopCartUI.CloseSideMenu();
        });
    },

    saveCustomerEmail: function() {
        $('body').on('click', '#customerEmailWindow #saveCustomerEmailInput', function() {
            if($('#marketingMaterialOptIn').is(':checked')) {
                $('#requiredMarketingBox').removeClass('has-error');
                var input = {email: $('#customerEmailWindow #customerEmailInput').val()};
                $('#emailFeedback').html('');
                $.ajax({
                    url: shopCartUI.baseURL + 'index.php/main/save_customer_email',
                    data: input,
                    type: 'post',
                    dataType: 'json',
                    success: function (data) {
                        if (data.success) {
                            $('#marketingMaterialOptIn').prop('checked', true);
                            $('#customerEmailWindow #customerEmailInput').val('');
                            $('#emailFeedback').css('display', 'block').html('<div class="alert alert-success"><i class="fa fa-check-circle"></i> ' + data.msg + '</div>');
                        } else {
                            $('#emailFeedback').css('display', 'block').html('<div class="alert alert-danger"><i class="fa fa-times-circle"></i> ' + data.msg + '</div>');
                        }

                        ShopdataUI.setSlideOutAlert('emailFeedback');
                    },
                    error: function (data) {
                        shopCartUI.handleCartError(data);
                    }
                });
            } else {
                $('#requiredMarketingBox').addClass('has-error');
                $('#emailFeedback').css('display', 'block').html('<div class="alert alert-danger"><i class="fa fa-times-circle"></i> Opt in checkbox is required</div>');
                ShopdataUI.setSlideOutAlert('emailFeedback');
            }
        });
    },

    setSlideOutAlert: function(elementId) {
        if (ShopdataUI.timeOutSetter) {
            clearTimeout(ShopdataUI.timeOutSetter); //cancel the previous timer.
            ShopdataUI.timeOutSetter = null;
        }
        ShopdataUI.timeOutSetter = setTimeout(function () {
            $('#'+elementId).slideUp()
        }, 4000);
    },

    scheduleDateTimeWindow: function() {
        $('body').on('click', '.scheduleDateTimeWindow ', function() {
            if (!ShopdataUI.isCartReadOnly && !$(this).hasClass('disabled')) {
                var type = $(this).attr('data-type');
                $.ajax({
                    url: ShopdataUI.baseURL + 'index.php/main/scheduleDateWindow',
                    type: 'post',
                    dataType: 'json',
                    data: {type: type, GREETING_ID: ShopdataUI.data.SDGREETID},
                    success: function(data) {
                        if(data.success) {
                            var titleType = type == 'D' ? 'Delivery' : 'Pick Up';

                            shopCartUI.openModal('modal-lg', 'Schedule ' + titleType + ' Date', data.html, 'schedulerDateTimeWindow');
                            ShopdataUI.scheduleDateSelected();
                            ShopdataUI.scheduleWindowTime();

                            var delDate = ShopdataUI.data.SCDELDATE;
                            if (delDate != '') {
                                var day = delDate.toString().substring(8, 6);
                                $('.calendarContent .circle .date').each(function () {
                                    if ($(this).html().trim() == day.trim()) {

                                        var selectedDate = 0;
                                        var timesAvailable = '';
                                        var selected = '';

                                        if (ShopdataUI.data.SCDELTYPE == 'D') {
                                            $(this).closest('.calendarContent').addClass('selected');

                                            selectedDate = $(this).closest('.calendarContent').attr('data-date');
                                            timesAvailable = $(this).closest('.calendarContent').attr('data-times');
                                            selected = ShopdataUI.getScheduledStartTime();
                                            document.cookie = "time="+selected+"; path=/;"; // SET THE TIME HERE FROM ShopdataUI.data.SCSCHTIME ADD IF SET CHECK
                                        }
                                        ShopdataUI.showScheduledDateSetting(selectedDate, timesAvailable, selected);
                                    }
                                });
                            }
                        } else {
                            shopCartUI.handleFailedAjaxCall(data);
                        }

                    },
                    error: function() {
                        shopCartUI.handleCartError();
                    }
                });

            } else {
                shopCartUI.displayMsg('Invoice can not be maintained.');
            }
        });

        // LISTEN FOR THE WINDOW TO CLOSE TO UPDATE THE VIEW
        $('body').on('hidden.bs.modal', '#schedulerDateTimeWindow', function () {
            shopCartUI.updateAppSections('shoppingCartSection');
        });

    },

    getScheduledStartTime: function() {
        var startTime = ShopdataUI.data.JWIN1BEG.toString();
        var endTime = ShopdataUI.data.JWIN1END.toString();

        var selected = '';
        if(startTime > 0 && endTime > 0) {
            startTime = startTime.length < 4 ? '0'+startTime : startTime;
            endTime = endTime.length < 4 ? '0'+endTime : endTime;

            selected = startTime+endTime;
        }

        return selected;
    },

    saveScheduledDateTime: function() {
        $('body').on('click', '#saveScheduledDate ', function() {
            var scheduled = document.cookie.match('(^|;) *scheduled=([^;]*)');
            var time = document.cookie.match('(^|;) *time=([^;]*)');
            $('#saveScheduledFeedback').html('');
            if(scheduled !== null) {
                scheduled = scheduled[2];
                if (time !== null) {
                    time = time[2];
                }

                $.ajax({
                    url: ShopdataUI.baseURL + 'index.php/main/saveScheduledDate',
                    type: 'post',
                    dataType: 'json',
                    data: {date: scheduled, time: time, GREETING_ID: ShopdataUI.data.SDGREETID},
                    success: function(data) {
                        if(data.success) {
                            $('#schedulerDateTimeWindow').modal('hide');
                            shopCartUI.updateAppSections();
                        } else {
                            $('#availableTimeSlots').val(ShopdataUI.getScheduledStartTime());
                            $('#saveScheduledFeedback').html('<i class="fa fa-exclamation-triangle"></i> '+data.msg);
                        }
                    },
                    error: function() {
                        shopCartUI.handleCartError();
                    }
                });
            } else {
                $('#availableTimeSlots').val(ShopdataUI.getScheduledStartTime());
                $('#saveScheduledFeedback').html('<i class="fa fa-exclamation-triangle"></i> You must select a date before saving');
            }

        });
    },

    refreshDeliveryCalendar: function(error) {
        var currentMonth = $('#cartSkuDatesWindow').attr('data-currentyearmonth');
        var url = ShopdataUI.baseURL+"index.php/main/scheduleDateWindow/"+currentMonth;

        ShopdataUI.showDeliveryCalendarView(url, 'D', error);
    },

    scheduleDateSelected: function() {
        $('body').on('click', '.calendarContent', function() {
            var elem = $(this);
            $('#saveScheduledFeedback').html('');
            if(!elem.hasClass('calClosed')) {
                $('#selectedCalendarDateTime').addClass('hide');
                var date = $(this).attr('data-date');
                $.ajax({
                    url: shopCartUI.baseURL+'index.php/main/schedulePreferredDate',
                    type: 'post',
                    dataType: 'json',
                    data: {DTYPE: 'D', GREETING_ID: ShopdataUI.data.SDGREETID, DSTORE: ShopdataUI.data.SCDELSTR, DDATE: date},
                    success: function(data) {
                        if(data.success) {
                            $('.calendarContent').removeClass('selected');
                            elem.addClass('selected');
                            var selectedDate = elem.attr('data-date');
                            var timesAvailable = elem.attr('data-times');
							document.cookie = "time=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                            var selected = '';

                            ShopdataUI.showScheduledDateSetting(selectedDate, timesAvailable, selected);
                        } else {
                            $('#saveScheduledFeedback').html('<div class="alert alert-danger"><i class="fa fa-times"></i> Error: '+data.msg+'</div>');
                        }
                    },
                    error: function() {
                        $('#saveScheduledFeedback').html('<div class="alert alert danger"><i class="fa fa-times"></i> Error: Failed to save date, please try again. If the problem persists please contact support.</div>');
                    }
                });
            }
        });
    },

    showScheduledDateSetting: function(date, times, selected) {
        if(date != 0) {
            $('#selectedCalendarDateTime').animate({opacity: '0'}, function () {
                $('#calendarSelectedDate').html(date);
                $('#selectedCalendarDateTime').animate({opacity: '1'});

                $('#selectedCalendarDateTime').removeClass('hide');
                document.cookie = "windows=" + times + "; path=/;";

                /* SET THE DELIVERY TIMES OPTIONS */
                if (times !== null && times != '') {
                    var timesArray = times.split('|');
                    var optionView = '<option value="">No Preferred Time</option>';
                    for (var i in timesArray) {
                        optionView += ShopdataUI.setOptionBasedOffTime(timesArray[i], selected);
                    }
                } else {
                    if(selected > 0) {
                        var optionView = '<option value="">No Preferred Time</option>';
                        optionView += ShopdataUI.setOptionBasedOffTime(selected, selected);
                    } else {
                        var optionView = '<option value="">No Preferred Times Available</option>';
                    }
                }

                $('#availableTimeSlots').html(optionView);
                document.cookie = "scheduled=" + date + "; path=/;";
            });

            $('#selectedCalendarDateTime').clearQueue();
        }
    },

    setOptionBasedOffTime: function(time, selected) {
        var startHour = time.substring(0, 2);
        var endHour = time.substring(6, 4);

        var startTime = time.substring(4, 2);
        var endTime = time.substring(8, 6);

        var startAmPm = startHour > 11 ? 'pm' : 'am';
        var endAmPm = endHour > 11 ? 'pm' : 'am';

        startHour = startHour > 12 ? startHour - 12 : startHour;
        endHour = endHour > 12 ? endHour - 12 : endHour;

        var selectedOption = selected == time ? 'selected' : '';

        var option = '<option ' + selectedOption + ' value="' + time + '">' + startHour + ':' + startTime + ' ' + startAmPm + ' - ' + endHour + ':' + endTime + ' ' + endAmPm + '</option>';

        return option;
    },

    destroyDeliveryWindow: function() {
        $('body').off('click', '.calendarContent');
        $('body').off('click', '#saveScheduledDate');
        $('body').off('change', '#availableTimeSlots');
        $('body').off('change', '#saveScheduledDate');
       /// $('body').off('hidden', '#schedulerDateTimeWindow');

        document.cookie = "scheduled=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        document.cookie = "time=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        document.cookie = "windows=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
    },

    scheduleWindowTime: function() {
        $('body').on('change', '#availableTimeSlots', function() {
            var time = $(this).val();
            $('#saveScheduledFeedback').html('');

            $.ajax({
                url: ShopdataUI.baseURL + 'index.php/main/schedule_time',
                type: 'post',
                dataType: 'json',
                data: {time: time, GREETING_ID: ShopdataUI.data.SDGREETID},
                success: function(data) {
                    if(data.success) {
                        document.cookie = "time="+time+"; path=/;";
                    } else {
                        if(data.data.refresh == true) {
                            ShopdataUI.refreshDeliveryCalendar(data.msg);
                        } else {
                            $('#saveScheduledFeedback').html('<div class="alert alert-danger"><i class="fa fa-times-circle"></i> Error: '+data.msg+'</div>');
                            $('#availableTimeSlots').val(ShopdataUI.getScheduledStartTime());
                        }
                    }
                },
                error: function() {
                    $('#saveScheduledFeedback').html('<div class="alert alert-danger"><i class="fa fa-times-circle"></i> Error: There was an error saving the time window, try again</div>');
                    $('#availableTimeSlots').val(ShopdataUI.getScheduledStartTime());
                }
            });

        });
    },

    refreshDeliveryTimes: function() {
            var delDate = ShopdataUI.data.SCDELDATE;
            if(delDate>0) {
                var date = $('.calendarContent.date' + delDate).attr('data-date');
                var times = $('.calendarContent.date' + delDate).attr('data-times');
                ShopdataUI.showScheduledDateSetting(date, times)
            }
    },

    scheduleDateTimeMonthChange: function() {
        $('body').on('click', '.showNewMonthSchedule ', function(event) {
            event.preventDefault();
            var type = $('#cartSkuDatesWindow').attr('data-type');
            var href = $(this).attr('data-href');
            ShopdataUI.showDeliveryCalendarView(href, type);
        });
    },

    showDeliveryCalendarView: function(href, type, error) {
        $.ajax({
            url: href,
            type: 'post',
            dataType: 'json',
            data: {type: type, DTYPE: 'D', GREETING_ID: ShopdataUI.data.SDGREETID},
            success: function(data) {
                if(data.success) {
                    $('#schedulerDateTimeWindow .modal-body').html(data.html);

                    var cookies = document.cookie;
                    if (cookies) {

                        var scheduled = document.cookie.match('(^|;) *scheduled=([^;]*)');
                        var time = document.cookie.match('(^|;) *time=([^;]*)');
                        var windows = document.cookie.match('(^|;) *windows=([^;]*)');

                        if (scheduled !== null) {
                            scheduled = scheduled[2];
                            if (time) {
                                time = time[2];
                            }

                            if (windows) {
                                windows = windows[2];
                            }
                            ShopdataUI.showScheduledDateSetting(scheduled, windows, time);
                            //ShopdataUI.refreshDeliveryTimes();
                            if (error) {
                                $('#saveScheduledFeedback').html('<div class="alert alert-danger"><i class="fa fa-times-circle"></i> Error: ' + error + '</div>');
                            }
                        }
                    }
                } else {
                    shopCartUI.handleFailedAjaxCall(data);
                }
            },
            error: function() {
                shopCartUI.handleCartError();
            }
        });
    },

    viewFileManager: function() {
        $('body').on('click', '#viewFileManager', function() {
            $.ajax({
                url: ShopdataUI.baseURL + 'index.php/main/file_manager',
                type: 'post',
                dataType: 'json',
                data: {},
                success: function(data) {
                    ShopdataUI.loadFileManagerView(data);
                    shopCartUI.CloseSideMenu();
                },
                error: function() {
                    shopCartUI.handleCartError();
                    shopCartUI.CloseSideMenu();
                }
            });
        });
    },

    searchForDocument: function() {
        $('body').on('keyup', '#searchFile', function () {
            $('#searchResultsForFiles').html('');
            $('#viewUnreadFiles').prop('checked', false);
            var found = false;
            var searchStr = $(this).val().replace(/[^a-zA-Z0-9 ]/g, "").toUpperCase();
            if($(this).val().length > 2) {
                $('#documentsList .list-group .markFileAsRead').each(function() {
                    var fileName = $(this).find('.documentFileName').html().toUpperCase();
                    if(fileName.search(searchStr) != -1) {
                        $('#searchResultsForFiles').append( $(this).clone());
                        found = true;
                    }
                });
            }

            if(searchStr.length > 2) {
                $('#fileManagerWindow #searchResultsForFiles').removeClass('hide');
                $('#fileManagerWindow #documentsList').addClass('hide');
                if(!found) {
                    $('#searchResultsForFiles').html('<div class="list-group-item list-group-item-danger"><i class="fa fa-times"></i> No results found</div>');
                }
            } else {
                $('#fileManagerWindow #searchResultsForFiles').addClass('hide');
                $('#fileManagerWindow #documentsList').removeClass('hide');
            }
        });
    },

    fileManagerViewUnread: function() {
      $('body').on('click', '#viewUnreadFiles', function() {
          $('#searchFile').val('');
          $('#searchResultsForFiles').html('');
         if($(this).is(':checked')) {
             $('#documentsList .list-group .markFileAsRead').each(function() {
                 if($(this).find('.unread-alert').length) {
                     $('#searchResultsForFiles').append( $(this).clone());
                 }
             });

             if($('#searchResultsForFiles').html() == '') {
                 $('#searchResultsForFiles').html('<div class="list-group-item list-group-item-danger"><i class="fa fa-times"></i> No unread files found</div>');
             }
             $('#fileManagerWindow #searchResultsForFiles').removeClass('hide');
             $('#fileManagerWindow #documentsList').addClass('hide');
         } else {
             $('#fileManagerWindow #searchResultsForFiles').addClass('hide');
             $('#fileManagerWindow #documentsList').removeClass('hide');
         }
      });
    },

    loadFileManagerView: function(data) {
        var html = '';
        if(typeof data.files !== 'undefined') {
            html += '<div class="form-group has-search">';
                html += '<span class="fa fa-search form-control-feedback"></span>';
                html+= '<input type="text" id="searchFile" placeholder="Search for file" class="form-control">';
                html += '<div class="row">';
                    html += '<div class="col-xs-6">';
                        html += '<span class="text-muted text-sm-left">Min 3 Characters</span>';
                    html += '</div>';
                    html += '<div class="col-xs-6 text-right">';
                        html += '<label><input type="checkbox" id="viewUnreadFiles" style="position: relative;top: 2px;"> View Unread</lable>';
                    html += '</div>';
                html += '</div>';
            html += '</div>';
            html += '<div id="documentsList" class="list-group">';
            for(i in data.files) {
                if(Number.isInteger(Number(i))) {
                    html += ShopdataUI.displayFileNameWithLink(data.files[i]);
                } else {
                    if(i) {
                        html += '<a href="#" class="list-group-item list-group-item-action directoryLink">';
                        html += '<b><i class="fa fa-folder-o"></i> &nbsp;' + i + '</b>';
                        html += '</a>';
                        html += '<div class="hiddenFolderStructure hide">';
                    }

                    html += ShopdataUI.listFilesInDirectory(data.files[i]);
                    if(i) {
                        html += '</div>';
                    }
                }
            }

            html += '</div>';
            html += '<div id="searchResultsForFiles" class="list-group"></div>';
        }
        shopCartUI.openModal('modal-lg', 'Documents', html, 'fileManagerWindow');
    },

    listFilesInDirectory: function(files, recursive = false) {
        if(typeof files != null && files !== '') {
            var html = '<div class="list-group">';
            for (i in files) {
                if (Number.isInteger(Number(i))) { /* file is a file */
                    html += ShopdataUI.displayFileNameWithLink(files[i]);
                } else if(i) { /* is directory */
                    html += '<a href="#" class="list-group-item list-group-item-action directoryLink">';
                        html += '<b><i class="fa fa-folder-o"></i> &nbsp;' + i + '</b>';
                    html += '</a>';
                    html += '<div class="hiddenFolderStructure hide">';
                        html += ShopdataUI.listFilesInDirectory(files[i]);
                    html += '</div>';
                }
            }
            html += '</div>';

            return html;
        }
    },

    displayFileNameWithLink: function(file) {
        var html = '<a href="' + file.file_url + '" ' +
            'target="_blank" ' +
            'class="list-group-item list-group-item-action markFileAsRead"' +
            'data-path="' + file.FVFILPATH + '">';
            html += '<i class="fa ' + file.icon + '"></i> &nbsp;';
            html += '<div class="pull-right text-right fileManagerDetails">';
                html += '<span class="">Added: ' + file.FVEFFBEG + '</span>';
                if(!file.HAS_READ) {
                    html += '<span class="text-danger unread-alert">&nbsp;<i class="fa fa-bell-o"></i></span>';
                }
        html += '</div>';
            html += '<span class="documentFileName">' + file.readable_name + '</span>';
        html += '</a>';

        return html;
    },

    toggleDirectoryView: function() {
      $('body').on('click', '.directoryLink', function () {
          $(this).find('.fa').toggleClass('fa-folder-open-o');
          $(this).next().toggleClass('hide');
      });
    },

    markFileAsRead: function() {
        $('body').on('click', '.markFileAsRead', function() {
            var elem = $(this);
            var path = $(this).attr('data-path');
            $.post(
                ShopdataUI.baseURL + 'index.php/main/mark_file_as_read',
                {path:path},
                function(data){
                    $('#fileManagerWindow').find('[data-path="'+path+'"]').find('.unread-alert').remove();
                   if(data.unread > 0) {
                       $('.unreadBadge').removeClass('hide').html(data.unread);
                   } else {
                       $('.unreadBadge').addClass('hide').html(data.unread);
                   }
                },
             'json');
        });
    },

    profileSettings: function() {
        $('#profileSettings').click(function() {
            ShopdataUI.openProfileSettings();
            shopCartUI.CloseSideMenu();
        });

        var cookies = document.cookie;
        if (cookies) {
            var showedProfile = document.cookie.match('(^|;) *showedProfileSettings=([^;]*)');
            if ($('#profileSettings').data('show') == 'y' && showedProfile == null) {
                ShopdataUI.openProfileSettings({'PROFILE_EMAIL': 'Please set your email address so we can use it in the app'});
                document.cookie = "showedProfileSettings=true; path=/;";
            }
        }
    },

    openProfileSettings: function(optionalMessage) {
        $.ajax({
            type: "POST",
            data: {optional_message: optionalMessage},
            url: shopCartUI.baseURL + 'index.php/main/load_profile_settings',
            dataType: 'json',
            success: function (data) {
                if(data.success) {
                    var buttons = [
                        {
                            id: 'saveProfileSettings',
                            name: 'Save',
                            class: 'btn btn-danger',
                            data: '',
                        },
                    ];

                    shopCartUI.openModal('modal-md', 'Profile Settings', data.data.view, 'profileSettingsWindow', buttons);
                    $('#PROFILE_PHONE').mask('(000) 000-0000');

                } else {
                    alert('Error pulling in the view, try again. If the problem persists please contact support.');
                }
            },
            error: function () {
                alert('Error pulling in the view, try again. If the problem persists please contact support.');
            }
        });
    },

    saveProfileSettings: function() {
        $('body').on('click', '#saveProfileSettings', function(event) {
            event.preventDefault();
            var formData = $('#profileSettingsForm').serialize();
            $('.form-group').removeClass('has-error');
            $('.input-feedback').html('');
            $.ajax({
                type: "POST",
                data: formData,
                url: shopCartUI.baseURL + 'index.php/main/save_profile_settings',
                dataType: 'json',
                success: function (data) {
                    if(data.success) {
                        $('#profileSettingsWindow').modal('hide');
                    } else {
                        ShopdataUI.handleFailedFormSubmission(data.data);
                    }
                },
                error: function () {
                    alert('Error pulling in the view, try again. If the problem persists please contact support.');
                }
            });
        });
    },

    generateNewLead: function() {
        $('body').on('click', '#generateLead', function() {
            $.post(shopCartUI.baseURL + 'index.php/main/generate_lead', function (data) {
                if(data.success) {
                    $('#pastPurchases').removeClass('hide');
                    shopCartUI.updateAppSections();
                } else {
                    shopCartUI.openModal('', '<i class="fa fa-exclamation-triangle"></i> Error', data.msg);
                }
                shopCartUI.CloseSideMenu();
            }, 'json');
        });
    },

    handleFailedFormSubmission: function(data) {
        for(var i in data) {
            var value = data[i];
            var inputId = i;
            if(inputId != '') {
                $('#' + inputId).closest('.form-group').addClass('has-error').find('.input-feedback').html(value);
            }
        }

    },

    viewConfigurationGuide: function(event) {
        event.preventDefault();
        var image = $(this).attr('data-image');
        var page = '<img src="'+shopCartUI.baseURL+'images/' + image + '" class="img-responsive" />';
        shopCartUI.openModal('modal-lg', 'Configuration Guide', page, 'configurationGuide');
    }
};


var PW =
{
	clickEventToUse: 'click',

	Bind: function(clickeventtouse)
    {
		if(arguments.length==1 && arguments[0]!=null && arguments[0].trim().length>0){
    		PW.clickEventToUse==arguments[0];
        }

		$CACHE('.ProductWindowTab').on(PW.clickEventToUse,PW.Tab);
        $CACHE('#ProductWindowImageZoom').on(PW.clickEventToUse,PW.ImageZoomClick);
        $('body').on(PW.clickEventToUse,'.ProductWindowThumb', PW.ImageThumbClick);
        $CACHE('#ProductWindowImageZoom').on('load', PW.ImageThumbClick_Finish);
        $CACHE('#ProductWindowClose').on(PW.clickEventToUse,function (){
            $('#modalBg').css('background-color','lightgrey');
            $.post(ShopdataUI.baseURL+'index.php/main/clearSavedComponents', {});
        })
    },

    Open: function(data)
    {

        var RelatedImagesHtml = '';

        // Show data
        // Add to Cart button
        $CACHE('#ProductWindowAddToCart').toggle((typeof ShopdataUI.data.SDGREETID!='undefined' && data.addtocart=='Y' && data.showAddToCart))

        var skuComponents = false;

        //  Strings
        $('#backToOrgSku').html('');
        $('#orig_set_image').html('');
        if(data.Components != '') {
            $CACHE('#ProductWindow_Name').html(data.Components[0]['ORIG_SKU_NAME'] + '</a></div>');
            $CACHE('#ProductWindow_SKU').html(data.Components[0]['ORIG_SKU_NUMBER']);
            $CACHE('#ProductWindow_Dimension').html(data.Components[0]['ORIG_SKU_DIMENSION']);
            $CACHE('#ProductWindow_Price').html(data.Components[0]['ORIG_SKU_PRICE']);

            if(data.Components[0]['ORIG_SKU_NUMBER'] != data.Sku) {
                if(data.Components[0]['ORIG_IMG_PATH']) {
                    $('#orig_set_image').html('<img src="'+data.Components[0]['ORIG_IMG_PATH']+'"><p></p><p></p><hr>');
                }
                $('#backToOrgSku').html('<br><div class="original_sku_name"><a class="button_red_bordered" style="font-size: 1em;" onclick="shopCartUI.showProductInformation(this);" data-table="relatedSKUS" data-id="'+data.Components[0]['ORIG_ROW_ID']+'"><i class="fa fa-reply"></i> Back To Set</a></div>');
            }

            skuComponents = true;
            $('#ProductWindowLeftB2').removeClass('RowBTall');
        } else {
            $CACHE('#ProductWindow_Name').html(data.Name);
            $CACHE('#ProductWindow_SKU').html(data.Sku);
            $CACHE('#ProductWindow_Dimension').html(data.Dimension);
            $CACHE('#ProductWindow_Price').html(data.Price);
        }

        $('.component-dimensions').remove();
        var activeRowID = '';
        if(data.Components != '') {
            var addedComponents = [];
            var availtable = 'var relatedSKUS={';
            for(var i in data.Components) {
                var active = '';
                if(data.Components[i]['WISKUNBR'] == data.Sku) {
                    active = 'activeComponent';
                    activeRowID = data.Components[i]['ROW_ID'];
                }

                if(addedComponents.indexOf(data.Components[i]['ROW_ID']) == -1) {
                    addedComponents.push(data.Components[i]['ROW_ID']);
                    $('#ProductWindow_Dimension').after('<div class="component-dimensions"><a class="' + active + '" onclick="shopCartUI.showProductInformation(this);" data-table="relatedSKUS" data-id="' + data.Components[i]['ROW_ID'] + '" data-sku="'+data.Components[i]['WISKUNBR']+'">(' + data.Components[i]['WISKUNBR'] + ') ' + data.Components[i]['WIDIMENSON'] + '</a></div>');
                    availtable += '"' + data.Components[i]['ROW_ID'] + '":{';
                    availtable += '"ROWID":"' + data.Components[i]['ROW_ID'] + '", ';
                    availtable += '"USER_ID":"' + data.Components[i].SCEMPNUM + '", ';
                    availtable += '"CART_ID":"' + ShopdataUI.data.SCCARTID + '", ';
                    availtable += '"AHINQID":"' + data.Components[i]['ADINQID'] + '", ';
                    availtable += '"AHOPTSKU":"' + data.Components[i]['ADOPTSKU'] + '", ';
                    availtable += '"AHRELSKU":"' + data.Components[i]['WISKUNBR'] + '" ,';
                    availtable += '"AHSLSQTY":"1" ,';
                    availtable += '"AHEPPPRC":"1" ,';
                    availtable += '"AHFABPRC":"0" ,';
                    availtable += '"AHEPPSEL":"" ,';
                    availtable += '"AHFABSEL":"" ,';
                    availtable += '"ORIGINALSKU":"-1"} ,';
                }
            }

            if($('.activeComponent').length == 0) {
                if(data.Components[0]['CURRENT_SKU_NUMBER']) {
                    $('*[data-customerID="' + data.Components[0]['CURRENT_SKU_NUMBER'] + '"]').addClass('activeComponent');
                }
            }

            availtable += '"'+data.Components[0]['ORIG_ROW_ID']+'":{';
            availtable += '"ROWID":"'+data.Components[0]['ORIG_ROW_ID']+'", ';
            availtable += '"USER_ID":"'+ShopdataUI.data.SCEMPNUM+'", ';
            availtable += '"CART_ID":"'+ShopdataUI.data.SCCARTID+'", ';
            availtable += '"AHINQID":"'+data.Components[0]['ORIG_INQ_ID']+'", ';
            availtable += '"AHOPTSKU":"'+data.Components[0]['ORIG_OPT_SKU']+'", ';
            availtable += '"AHRELSKU":"'+data.Components[0]['ORIG_SKU_NUMBER']+'" ,';
            availtable += '"ORIGINALSKU":"-1"} ,';

            availtable += '}';
            $('#ProductWindow_Dimension').after('<div class="component-dimensions"><hr><strong>COMPONENTS:</strong></div>');

            $('#relatedSkuData').html('<script>'+availtable+'</script>');
        }

        $CACHE('#ProductWindow_BodyCopy').html(data.BodyCopy);

        //  Availability
        //      On Display
        $CACHE('#ProductWindow_Availability_OnDisplay_Empty').toggle(data.OnDisplayData.length == 0);
        $CACHE('#ProductWindow_Availability_OnDisplay_Table').toggle(data.OnDisplayData.length > 0);
        $CACHE('#ProductWindow_Availability_OnDisplay_Data').html((data.OnDisplayData.length > 0) ? PW.RenderTable(data.OnDisplayData) : '');
        //      In Stores
        $CACHE('#ProductWindow_Availability_InStores_Empty').toggle(data.InStoresData.length == 0);
        $CACHE('#ProductWindow_Availability_InStores_Table').toggle(data.InStoresData.length > 0);
        $CACHE('#ProductWindow_Availability_InStores_Data').html((data.InStoresData.length > 0) ? PW.RenderTable(data.InStoresData) : '');
        //      Delivery Center
        $CACHE('#ProductWindow_Availability_DeliveryCenter_Empty').toggle(data.DeliveryCenterData.length == 0);
        $CACHE('#ProductWindow_Availability_DeliveryCenter_Table').toggle(data.DeliveryCenterData.length > 0);
        $CACHE('#ProductWindow_Availability_DeliveryCenter_Data').html((data.DeliveryCenterData.length > 0) ? PW.RenderTable(data.DeliveryCenterData) : '');

        //  Images On/Off
        $CACHE('#ProductWindow_PurePromise').toggle(data.IsPurePromise);
        $CACHE('#ProductWindow_Clearance').toggle(data.IsClearance);

        //  Images
        if(data.Images.length > 0)
        {
            // Render hero image
            var hero = new Image();
            hero.src = data.Images[0];
            hero.onload = function()
            {
                // Resize hero container to aspect ratio
                if(this.height > this.width)
                {
                    // Tall
                    $('.RowB').removeClass('RowBSquare').removeClass('RowBWide').addClass('RowBTall');
                    $('.Col2').removeClass('Col2Square').removeClass('Col2Wide').addClass('Col2Tall');
                }
                else if(this.width > this.height)
                {
                    // Wide
                    $('.RowB').removeClass('RowBSquare').removeClass('RowBTall').addClass('RowBWide');
                    $('.Col2').removeClass('Col2Square').removeClass('Col2Tall').addClass('Col2Wide');
                }
                else
                {
                    // Square
                    $('.RowB').removeClass('RowBTall').removeClass('RowBWide').addClass('RowBSquare');
                    $('.Col2').removeClass('Col2Tall').removeClass('Col2Wide').addClass('Col2Square');
                }

                // Show hero
                $CACHE('#ProductWindow_Hero').show();

            };

            // Hide hero while waiting to load and resize container
            $CACHE('#ProductWindow_Hero')
                .hide()
                .attr('src', data.Images[0]).prop('style', '');

            // Render related images
            $CACHE('#ProductWindow_RelatedImages').empty();
            for(var i = 0; i < data.Images.length; i++)
            {
                // Load image
                var related = new Image();
                related.src = data.Images[i];
                related.onload = function()
                {
                    // Select aspect ratio class
                    var thumbClass = '';
                    if(this.height > this.width)
                    {
                        thumbClass = 'ProductWindowThumbTall';
                    }
                    else if(this.width > this.height)
                    {
                        thumbClass = 'ProductWindowThumbWide';
                    }
                    else
                    {
                        thumbClass = 'ProductWindowThumbSquare';
                    }

                    // Render image
                    $CACHE('#ProductWindow_RelatedImages').append('<img src="'+this.src+'" class="ProductWindowThumb '+thumbClass+'" />');
                };
            }

        } else {
        	$CACHE('#ProductWindow_Hero').attr('src','http://s7d4.scene7.com/is/image/ASF/no_image');
        	$CACHE('#ProductWindow_RelatedImages').empty();

        }

        //  Details
        $CACHE('#ProductWindow_Details_Empty').toggle(
            data.FabricData.length == 0
            && data.GroupData.length == 0
            && data.FeaturesBenefits.length == 0
        );

        //      Fabric
        $CACHE('#ProductWindow_Details_Fabric_Table').toggle(data.FabricData.length > 0);
        $CACHE('#ProductWindow_Details_Fabric_Data').html((data.FabricData.length > 0) ? PW.RenderTable(data.FabricData) : '');

        //      Group Skus
        $CACHE('#ProductWindow_Details_Group_Table').toggle(data.GroupData.length > 0);
        $CACHE('#ProductWindow_Details_Group_Data').html((data.GroupData.length > 0) ? PW.RenderTable(data.GroupData) : '');

        //      Features & Benefits
        $CACHE('#ProductWindow_Details_FeaturesBenefits').toggle(data.FeaturesBenefits.length > 0);
        $CACHE('#ProductWindow_Details_FeaturesBenefits_Data').html(data.FeaturesBenefits);

        // Start Availability Tab
        PW.Tab(null, 'ProductWindowTab_Availability', 'ProductWindow_Availability');

        // Open dialog

        if(data.addtocart=='Y'){
            window.prodinfotable=new Array();
            if(skuComponents) {
                window.prodinfotable[data.skuKeys.ROWID]=data.skuKeys;
                $('#ProductWindowLeftC').attr('data-id',data.skuKeys.activeRowID);
            } else {
                window.prodinfotable[data.skuKeys.ROWID]=data.skuKeys;
                $('#ProductWindowLeftC').attr('data-id',data.skuKeys.ROWID);
            }

            $('#ProductWindowLeftC').attr('data-id',data.skuKeys.ROWID);

        }
    },

    RenderTable: function(data)
    {
        var html = '';

        // Enumerate objects
        for(var i = 0; i < data.length; i++)
        {
            // Add row
            html += '<tr>';

            for(var k in data[i])
            {
                // Assert data member
                if(data[i].hasOwnProperty(k))
                {
                    // Add cell per member
                    html += '<td>' + data[i][k] + '</td>';
                }
            }

            html += '</tr>';
        }

        return html;
    },

    Tab: function(e, _this, _tab)
    {
        THIS = (typeof(_this) !== 'undefined' ? $('#'+_this) : $(this));
        TAB = (typeof(_tab) !== 'undefined' ? _tab : $(this).data('tab'));

        // All tabs off
        $CACHE('.ProductWindowTab').removeClass('ProductWindowTabActive');
        // All content off
        $CACHE('.ProductWindowTabContent').hide();
        // This tab on
        THIS.addClass('ProductWindowTabActive');
        // This content on
        $('#'+TAB).show();
    },

    ImageThumbClick: function()
    {
        // Read Image URL
        var ClickImageSrc = $(this).attr('src');

        // Load image to trigger ImageThumbClick_Finish
        $CACHE('#ProductWindowImageZoom').attr('src', ClickImageSrc);
    },

    ImageThumbClick_Finish: function()
    {
    	var popup = $CACHE('#ProductWindowImageZoom');

        // Calculate center based on image size
        var X = Math.max(0, (($(window).width() - $(this).outerWidth()) / 2) + $(window).scrollLeft());
        var Y = Math.max(0, (($(window).height() - $(this).outerHeight()) / 2) + $(window).scrollTop());

        // Center and show
        $CACHE('#ProductWindowImageZoom')
            .css(
                {
                    'top':      Y+'px',
                    'left':     X+'px'
                }
            )
            .show();
    },

    ImageZoomClick: function()
    {
        // Clear and Hide Zoom Image
        $CACHE('#ProductWindowImageZoom')
            .attr('src', '')
            .hide();
    }


};

var LoginWindow =
{
    loginJQXHR: null,
    customers: [],
    clickEventToUse: 'click',

    Bind: function(clickeventtouse)
    {
    	if(arguments.length==1 && arguments[0]!=null && arguments[0].trim().length>0){
    		LoginWindow.clickEventToUse==arguments[0];
        }

    	// Form view
        //  Keyboard handler
        $('#LoginWindowEmail, #LoginWindowPhone, #LoginWindowEasyPass')
            .keydown(LoginWindow.Form_KeyboardEnter)
            .keypress(LoginWindow.Form_KeyboardEnter);
        //  Phone mask
        $('#LoginWindowPhone').mask('(000) 000-0000');
        //  Go
        $('#LoginWindowGo').on(LoginWindow.clickEventToUse,
    		function (){
				var easypass = $CACHE('#LoginWindowEasyPass').val().trim();
				if (easypass.length==0){
					LoginWindow.Form_Go();
				} else {
					LoginWindow.checkIfValidEasyPass(LoginWindow.Form_Go);
				}
			}
        );
        // Loading view
        //  Abort
        $('#LoginWindowLoadingAbort').on(LoginWindow.clickEventToUse,LoginWindow.Loading_Abort);

        // Customer view
        //  List
        $('body').on('click','#LoginWindowCustomerSelectTable tr td,'
                           + ' #LoginWindowCustomerSelectTable tr td input,'
                           + ' #LoginWindowCustomerSelectTable tr td div',  LoginWindow.Customer_List);

        //$('#LoginWindowCustomerSelect').on(LoginWindow.clickEventToUse,LoginWindow.Customer_Select);
        $('#LoginWindowNotFoundOK').on(LoginWindow.clickEventToUse,LoginWindow.Close);
        $('#LoginWindowNewCustomer1,#LoginWindowNewCustomer2,#LoginWindowNewCustomer3').on(LoginWindow.clickEventToUse,ShopdataUI.addCustomerInfoFromLookup);
    },

    ViewSet: function(view)
    {
        // Show selected view and hide others
        $CACHE('#LoginWindowForm').toggle(view == 'form');
        $CACHE('#LoginWindowLoading').toggle(view == 'loading');
        $CACHE('#LoginWindowCustomer').toggle(view == 'customer');
        $CACHE('#LoginWindowWelcome').toggle(view == 'welcome');
        $CACHE('#LoginWindowNotFound').toggle(view == 'notfound');
    },

    Form_KeyboardEnter: function(e)
    {
        // Assert Enter pressed
    	if (!e) e = window.event;
        var code = (e.keyCode) ? e.keyCode : e.which;
        if (code == 13 || code == 3)
        {
            // Click Go button
            LoginWindow.Form_Go();
            return false;
        }
        return true;
    },

    Form_Go: function()
    {
        // Read input
        var Email = $('#LoginWindowEmail').val();
        var EmailSet = (Email.length > 0);
        var EmailValid = ShopdataUI.ValidEmail(Email);
        var Phone = $('#LoginWindowPhone').cleanVal().toString();
        var PhoneSet = (Phone.length > 0);
        var PhoneValid = (Phone.length == 10);
        var EasyPass = $('#LoginWindowEasyPass').val();
        var EasyPassSet = (EasyPass.length > 0);
        var EasyPassValid = (EasyPass.length < 10);

        ShopdataUI.customerLookup =
        {
    		email: (EmailValid ? Email : ''),
            phone: (PhoneValid ? Phone : '')
        }

        $('body').scrollTop(0);

        // Show validation
        $CACHE('#LoginWindowEmailValid').html(EmailSet && !EmailValid ? '<span>&nbsp;* Invalid&nbsp;</span>' : '');
        $CACHE('#LoginWindowPhoneValid').html(PhoneSet && !PhoneValid ? '<span>&nbsp;* Invalid&nbsp;</span>' : '');
        $CACHE('#LoginWindowEasyPassValid').html(EasyPassSet && !EasyPassValid ? '<span>&nbsp;* Invalid&nbsp;</span>' : '');
        // Assert one valid field
        if(EmailValid || PhoneValid || (EasyPassSet && EasyPassValid))
        {
            // Show loading
        	LoginWindow.loginJQXHR = $.post(
				ShopdataUI.baseURL+'index.php/main/ShopData_LookupCustomer',
				{
					email: (EmailValid ? Email : ''),
					phone: (PhoneValid ? Phone : ''),
					easypass: (EasyPassSet && EasyPassValid ? EasyPass : ''),
                    GREETING_ID: ShopdataUI.data.SDGREETID,
				},
				function(dataString)
				{
					var data = JSON.parse(dataString);
					if(data.success) {
						LoginWindow.Customer_Render(data);
						if (data.isCustomerOnly){
							$('#LoginWindowNewCustomer1,#LoginWindowNewCustomer2,#LoginWindowNewCustomer3').show();
						} else {
							$('#LoginWindowNewCustomer1,#LoginWindowNewCustomer2,#LoginWindowNewCustomer3').hide();
						}
					} else {
						LoginWindow.ViewSet('notfound');
						$('#LoginWindowNewCustomer1,#LoginWindowNewCustomer2,#LoginWindowNewCustomer3').show();
					}
					ShopdataUI.customerLookup.phone = Phone;
					ShopdataUI.customerLookup.email = Email;
				}
			).fail(function(data) {try { shopCartUI.handleCartError(data); }catch(err){}});
        }
    },

    checkIfValidEasyPass: function(callbackfunction)
    {
    	$('#LoginWindowEasyPass').addClass('ui-autocomplete-loading');
		var easypass = $CACHE('#LoginWindowEasyPass').val().trim();
    	$.ajax({
	        type: "POST",
	        url: ShopdataUI.baseURL+'index.php/main/checkIfValidEasyPass',
	        data: {
                	easypass: easypass
            	  },
	        dataType: 'html',
	        success: function(dataString) {
	        	var data = JSON.parse(dataString);
	        	$('#LoginWindowEasyPassValid').html(data.isValid?'':'<span>&nbsp;* Invalid&nbsp;</span>');
	        	$('#LoginWindowEasyPass').removeClass('ui-autocomplete-loading');
	        	if (data.isValid) callbackfunction();
	        },
	        error: function (dataString){
	        	shopCartUI.checkIfNetworkError();
	        }
        });
    },

    Loading_Abort: function()
    {
        // Abort ajax
        LoginWindow.loginJQXHR.abort();
        LoginWindow.loginJQXHR = null;
        LoginWindow.ViewSet('form');
    },

    Close: function()
    {
    	ShopdataUI.customerLookup = {};
    },

    Customer_Render: function(data)
    {
        var customerHTML = '', cartInfo = '', typeClass = '', custEmailPhone;
        var customers = data.customers;
        var customerHeaderAll = '<tr>'
        		+ '<th style="width: 10px;">&nbsp;</th>'
        		+ '<th class="LoginWindowCustomerSelectName">Name</th>'
        		+ '<th class="LoginWindowCustomerSelectAddress">Address</th>'
        		+ '<th class="LoginWindowCustomerSelectEmail">Email/Phone</th>'
        		+ '<th class="LoginWindowCustomerSelectSName">Store</th>'
        		+ '<th class="LoginWindowCustomerSelectHFCName">HFC Name</th>'
        		+ '<th class="LoginWindowCustomerSelectCartID">Cart ID</th>'
        		+ '<th class="LoginWindowCustomerSelectTotalPrice">Total Price</th>'
        		+ '<th class="LoginWindowCustomerSelectType">Last Visit</th>'
        		+ '</tr>';
        var customerHeaderOnly = '<tr>'
                + '<th style="width: 10px;">&nbsp;</th>'
                + '<th class="LoginWindowCustomerSelectName">Name</th>'
                + '<th class="LoginWindowCustomerSelectAddress">Address</th>'
                + '<th class="LoginWindowCustomerSelectEmail">Email/Phone</th>'
                + '</tr>';
        var customerHeader = (data.isCustomerOnly ? customerHeaderOnly : customerHeaderAll);

        // Save data
        LoginWindow.customers = customers;
        var showCustomerCart = false;
        $('#invoiceStyleCustomerLookup').remove();

        // Write HTML
        for(var i = 0; i < customers.length; i++)
        {
            if(customers[i].SDCARTID != 0)
            {
                cartInfo = ShopdataUI.datePickerFromAS400(customers[i].SCLASTDATE) + ' ' + ShopdataUI.timeFromAS400(customers[i].SCLASTTIME);
            }
            else if(customers[i].SDGREETID != 0)
            {
                cartInfo = 'Shopping ' + ShopdataUI.datePickerFromAS400(customers[i].SCLASTDATE) + ' ' + ShopdataUI.timeFromAS400(customers[i].SCLASTTIME);
            }
            else
            {
                cartInfo = ''; //'New Cart With Customer Profile';
            }

            custEmailPhone = customers[i].SDCUSEMAIL;
            custEmailPhone += ((customers[i].SDCUSEMAIL.length > 0 && (customers[i].SDCUSPHON1 != 0 || customers[i].SDCUSPHON2 != 0)) ? '<br/>' : '');
            if(customers[i].SDCUSPHON1 != 0)
            {
            	var strPhone = customers[i].SDCUSPHON1.toString();
                custEmailPhone += '(' + strPhone.substr(0,3) + ') ' + strPhone.substr(3,3) + '-' + strPhone.substr(6,4);
            }
            if(customers[i].SDCUSPHON2 != 0)
            {
            	var strPhone = customers[i].SDCUSPHON2.toString();
                custEmailPhone += ' / (' + strPhone.substr(0,3) + ') ' + strPhone.substr(3,3) + '-' + strPhone.substr(6,4);
            }
            if (data.isCustomerOnly)
        	{
	            customerHTML += '<tr>'
	                         +  '   <td style="width:20px"><input type="radio" class="optCustomerSelect line2595" name="optCustomerSelect" data-select="2" value="' + i.toString() + '" /></td>'
	                         +  '   <td class="LoginWindowCustomerSelectName">'
	                                +   '<div data-select="2">'
	                                +   customers[i].SDCUSLNAME + ', ' + customers[i].SDCUSFNAME + ' ' + customers[i].SDCUSMID
	                                +   '</div>'
	                         +  '   </td>'
	                         +  '   <td class="LoginWindowCustomerSelectZip">' + customers[i].SDCUSADDR1 + '<br />' + customers[i].SDCUSCITY + ' ' + customers[i].SDCUSSTATE + ' ' + customers[i].SDCUSZIP + '</td>'
	                         +  '   <td class="LoginWindowCustomerSelectEmail">' + custEmailPhone + '</td>'
	                         +  '</tr>';
                $('#LoginWindowCustomerSelectTable').css('table-layout', 'fixed');
        	} else {
                if(typeof customers[i].cart != 'undefined' && customers[i].cart.length>0) {
                    var deliveryDate = '';
                    if(customers[i].SCDELDATE.length>1) {
                        deliveryDate = '<span class="red-highlight">'+customers[i].SCDELDATE+'</span>';
                    }

                    var deliveryType = '';
                    if(customers[i].SCDELTYPE == 'D' && deliveryDate) {
                        deliveryType = 'Delivery:';
                    } else if(customers[i].SCDELTYPE == 'P' && deliveryDate) {
                        deliveryType = 'Pick Up:';
                    }

                    /* TODO: This shouldn't be a table, or it should be a better table EM 2021-10-28 */
                    var customerDetailsHTML = '<table id="invoiceStyleCustomerLookup" style="width:98%; margin: 0 auto; line-height: 1.4;">'
                            +'<tr><td colspan="2" style="text-align:center;"><h2 style="margin: 0 0 -30px 0; padding:0;">('+customers[i].SDCARTSTR+') '+customers[i].SNAME+' - HFC '+customers[i].HFCNAME+'</h2></td></tr>'
                        + '<tr style="line-height: 1.3em;">'
                            + '<td style="width:45%;">'
                                + '<h3>CUSTOMER DETAILS</h3>'
                                + customers[i].SDCUSLNAME + ', ' + customers[i].SDCUSFNAME + ' ' + customers[i].SDCUSMID +'<br>'
                                + customers[i].SDCUSEMAIL +'<br>'
                                + customers[i].SDCUSADDR1 + '<br />'
                                + customers[i].SDCUSCITY + ' ' + customers[i].SDCUSSTATE + ' ' + customers[i].SDCUSZIP + '<br>'
                                + cartInfo
                                + '<input type="radio" style="display: none" class="optCustomerSelect" checked name="optCustomerSelect" data-select="2" value="' + i.toString() + '" />'
                            + '</td>'
                            + '<td>'
                                + '<table style="width: 60%; float: right;">'
                                    + '<tr>'
                                        + '<td colspan="2" style="text-align:center"><h3>INVOICE DETAILS</h3></td>'
                                    + '</tr>'
                                    + '<tr>'
                                        + '<td style="text-align: right">'
                                            + 'Cart Id: <br>'
                                            + 'HFC Name: <br>'
                                            + 'Store: <br>'
                                            + 'Total: <br>'
                                            + deliveryType
                                        + '</td>'
                                        + '<td style="text-align: left">'
                                             + customers[i].SDCARTID + '<br>'
                                             + customers[i].HFCNAME + '<br>'
                                             + customers[i].SNAME + '<br>'
                                             + '$' +customers[i].SCTOTPRC+ '<br>'
                                             + deliveryDate
                                        + '</td>'
                                    + '</tr>'
                                + '</table>'
                            + '</td>'
                        + '</tr>'
                        +  '</table>';


                    $('#LoginWindowCustomerHeader').remove();
                    $('#LoginWindowCustomerSelectTable').before(customerDetailsHTML);

                    var cartItems = customers[i].cart;
                    customerHTML += '<tr class="viewCustomerCartItemsLookup" data-row="'+i+'"><td style="text-align: center; font-size:1.2em; padding: 8px 0 5px 0;" colspan="10" >Cart Items</td></tr>';
                    customerHTML += '<tr>'
                        + '<td class="no-highlight" width="20">#</td>'
                        + '<td class="no-highlight">Item</td>'
                        + '<td class="no-highlight">Sku</td>'
                        + '<td class="no-highlight">Image</td>'
                        + '<td class="no-highlight">QTY</td>'
                        + '<td class="no-highlight">Per Unit</td>'
                        + '<td class="no-highlight">Price</td>'
                        + '<td class="no-highlight">Pure Promise</td>'
                        + '<td class="no-highlight">Pick Up</td>'
                        + '<td class="no-highlight">Delivery</td>'
                        +  '</tr>';

                    for(var c=0;c<cartItems.length;c++) {
                        var purePromise = '<div class="purepromiseInActive addEpp">Pure Promise</div>';
                        if(cartItems[c]['PUREPROMISE'] == 'y') {
                            purePromise = '<div class="purepromiseActive  addEpp">Pure Promise</div>';
                        }

                        var unitPrice = cartItems[c]['AHUNTPRC'];
                        if(cartItems[c]['AHUNTPRC'] < cartItems[c]['AHRTLPRC'] && cartItems[c]['AHUNTPRC'] > 0) {
                            unitPrice = '<span class="itemOnSale">'+cartItems[c]['AHRTLPRC']+' </span><br> $'+cartItems[c]['AHUNTPRC'];
                        }
                        if(cartItems[c]['FIRSTIMGTHUMB']) {
                            cartItems[c]['FIRSTIMGTHUMB'] = cartItems[c]['FIRSTIMGTHUMB'].replace('microImg', '');
                        }
                        //cartItems[c]['FIRSTIMGTHUMB'] = cartItems[c]['FIRSTIMGTHUMB'].replace('microImg', '');
                        customerHTML += '<tr class="'+cartItems[c]['CLASS']+'">'
                            + '<td class="no-highlight" width="20">'+(c+1)+'</td>'
                            + '<td class="no-highlight">'+cartItems[c]['WIITEMNAME']+'</td>'
                            + '<td class="no-highlight">'+cartItems[c]['AHOPTSKU']+'</td>'
                            + '<td class="no-highlight" style="text-align:center">'+cartItems[c]['FIRSTIMGTHUMB']+'</td>'
                            + '<td class="no-highlight">'+cartItems[c]['AHSLSQTY']+'</td>'
                            + '<td class="no-highlight">$'+unitPrice+'</td>'
                            + '<td class="no-highlight">$'+cartItems[c]['TOTAL']+'</td>'
                            + '<td class="no-highlight">'+purePromise+'</td>'
                            + '<td class="no-highlight">'+cartItems[c]['AHAVLDATE']+'</td>'
                            + '<td class="no-highlight">'+cartItems[c]['AHAVLDELDT']+'</td>'
                            +  '</tr>';
                    }
                    showCustomerCart = true;
                    $('#LoginWindowCustomerSelectTable').css('table-layout', 'auto');
                } else {
                    $('#LoginWindowCustomerSelectTable').css('table-layout', 'fixed');
                    customerHTML += '<tr>'
                        +  '   <td><input type="radio" class="optCustomerSelect" name="optCustomerSelect" data-select="2" value="' + i.toString() + '" /></td>'
                        +  '   <td class="LoginWindowCustomerSelectName">'
                        +   '<div data-select="2">'
                        +   customers[i].SDCUSLNAME + ', ' + customers[i].SDCUSFNAME + ' ' + customers[i].SDCUSMID
                        +   '</div>'
                        +  '   </td>'
                        +  '   <td class="LoginWindowCustomerSelectZip">' + customers[i].SDCUSADDR1 + '<br />' + customers[i].SDCUSCITY + ' ' + customers[i].SDCUSSTATE + ' ' + customers[i].SDCUSZIP + '</td>'
                        +  '   <td class="LoginWindowCustomerSelectEmail">' + custEmailPhone + '</td>'
                        +  '   <td class="LoginWindowCustomerSelectSName">' + customers[i].SNAME + '</td>'
                        +  '   <td class="LoginWindowCustomerSelectHFCName">' + customers[i].HFCNAME + '</td>'
                        +  '   <td class="LoginWindowCustomerSelectCartID">' + customers[i].SDCARTID + '</td>'
                        +  '   <td class="LoginWindowCustomerSelectTotalPrice">' + customers[i].SCTOTPRC + '</td>'
                        +  '   <td class="LoginWindowCustomerSelectType' + typeClass + '">' + cartInfo + '</td>'
                        +  '</tr>';
                }

        	}
        }

        // Render view
        if(showCustomerCart == false) {
            $('#LoginWindowCustomerSelect').addClass('buttonDialogDisabled').prop("disabled",true);
        }
        $('#LoginWindowCustomerHeader').html(customerHeader);
        $('#LoginWindowCustomerData').html(customerHTML);

        if (data.isCustomerOnly) {
            $('#LoginWindowCustomerSelectTable').css('table-layout', 'inherit')
        }

        LoginWindow.ViewSet('customer');

    },

    Customer_List: function(e)
    {
        var cells, cellParent;
        var target = e.target || e.srcElement;
        if(!$(e.target).hasClass('no-highlight')) {
            // Reset select
            $('#LoginWindowCustomerData tr td').removeClass('LoginWindowCustomerSelected');

            // Determine source
            var level = $(target).data('select');
            if (level == 2) {
                cellParent = target.parentElement.parentElement;
            }
            else {
                cellParent = target.parentElement;
            }

            cells = $(cellParent).children();
            $(cells).first().children().first().prop('checked', true);

            $(cells).addClass('LoginWindowCustomerSelected');
            $('#LoginWindowCustomerSelect').removeClass('buttonDialogDisabled').prop("disabled", false);
            $('#LoginWindowCustomerSelect').text('Select');
        }
    },
};

var CustomerInfo =
{
	clickEventToUse: 'click',

	Bind: function(clickeventtouse)
	{
		// initialize x button on textfields
        $('.clearable').clearable();

		// customer form tabs
        //$( "#tabs, #tabsDData, #tabsDelData" ).tabs({
         //   heightStyle: "content",
         //   show: { effect: "fade", duration: 1000 },
         //   hide: { effect: "fade", duration: 1000 }
        //});

        // Email verification
        if (ShopdataUI.useFreshAddressClientSide){
        	// Use FreshAddress to verify email address
        	$('body').on('blur','#SDCUSEMAIL, #SCSHPEMAIL, #LSDCUSEMAIL', faddr_integration.verifyEmail);
        } else {
        	// Just check the format of the email
        	$('body').on('blur','#SDCUSEMAIL, #SCSHPEMAIL, #LSDCUSEMAIL', ShopdataUI.ValidateEmailFormat);
        }

    	$('body').on('blur', '#SDCUSZIP, #SCSHPZIP', function() {
    		var addrselector = '#'+$(this)[0].id.replace('ZIP','ADDR1');
    		var addr2selector = '#'+$(this)[0].id.replace('ZIP','ADDR2');
    		var cityselector = '#'+$(this)[0].id.replace('ZIP','CITY');
    		var stateselector = '#'+$(this)[0].id.replace('ZIP','STATE');

            var addr = $(addrselector).val();
        	var oldValue = $(this).attr('oldValue');
            var currentValue = $(this).val().trim();
            if(currentValue!=='' && !ShopdataUI.ValidZIP(currentValue)) {
            	ShopdataUI.zipValid = false;
    			$('#'+$(this)[0].id+'_Invalid').show();
        	} else {
        		if (currentValue!==''){
	        		if (addr!=='' && oldValue!==currentValue){
		        		$(addrselector).val('');
		            	$(addrselector).attr('placeholder','ZIP Changed');
                        document.cookie = "VIEWED_FIT_WARNING= ; expires = Thu, 01 Jan 1970 00:00:00 GMT;path=/";
		            	if($(this).attr('id') == 'SDCUSZIP' && ShopdataUI.sync_customer) {
		            	    $('#SCSHPZIP').val('');
		            	    $('#SCSHPADDR1').val('');
		            	    $('#SCSHPADDR2').val('');
		            	    $('#SCSHPCITY').val('');
		            	    $('#SCSHPSTATE').val('');
                        }

		            	$(addr2selector).val('');
		            	$(cityselector).val('');
		            	$(stateselector).val('');
		        	} else {
		        		$(addrselector).attr('placeholder','');
		            }
        		} else {
        			$('#'+$(this)[0].id+'_Invalid').hide();
                    $(this).removeAttr('data-zglng');
                    $(this).removeAttr('data-lglat');
        		}
        	}
        });

    	$('body').delegate('#SDCUSZIP, #SCSHPZIP', 'focus', function(){
            $(this).attr('oldValue',$(this).val());
        }).keyup(function () {
            var zip = $(this).val();
        	$(this).val(zip.replace(/[^0-9\.]/g,''));
    	});

    	$('body').delegate('.clearable, .txtCustomerName', 'focus', function(){
    		$('.ui-multiselect-menu').hide();
    	});

    	$('body').delegate('.cmdCustomerSize', ShopdataUI.clickEventToUse, function(){
    		$('.ui-multiselect-menu').hide();
    	});
	},
};