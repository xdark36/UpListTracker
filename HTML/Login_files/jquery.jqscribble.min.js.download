function jqScribbleBrush(){jqScribbleBrush.prototype._init=function(t,e,n){this.context=t,this.context.globalCompositeOperation="source-over",this.brushSize=e,this.brushColor=n,this.drawn=!1,this.active=!1},jqScribbleBrush.prototype.strokeBegin=function(t,e){this.active=!0,this.context.beginPath(),this.context.lineWidth=this.brushSize},jqScribbleBrush.prototype.strokeMove=function(t,e){this.drawn=this.active},jqScribbleBrush.prototype.strokeEnd=function(){return this.active=!1,!!this.drawn&&(this.drawn=!1,!0)}}function BasicBrush(){BasicBrush.prototype.strokeBegin=function(t,e){jqScribbleBrush.prototype.strokeBegin.call(this,t,e),this.prevX=t,this.prevY=e},BasicBrush.prototype.strokeMove=function(t,e){jqScribbleBrush.prototype.strokeMove.call(this,t,e),this.context.moveTo(this.prevX,this.prevY),this.context.lineTo(t,e),this.context.strokeStyle=this.brushColor,this.context.stroke(),this.prevX=t,this.prevY=e}}function BasicCanvasSave(t){window.open(t,"jqScribble Image")}BasicBrush.prototype=new jqScribbleBrush,function(t){var e={width:300,height:250,backgroundImage:!1,backgroundImageX:0,backgroundImageY:0,backgroundColor:"#ffffff",saveMimeType:"image/png",saveFunction:BasicCanvasSave,brush:BasicBrush,brushSize:2,brushColor:"rgb(0,0,0)"};function n(t){var n=new Image;n.src=e.backgroundImage,n.onload=function(){t.drawImage(n,e.backgroundImageX,e.backgroundImageY)}}var s=function(s,r){var i=t(s),o=this,a=i.is("canvas"),h=a?i[0]:document.createElement("canvas"),u=h.getContext("2d"),c=i.innerWidth(),b=i.innerHeight();t.extend(e,r),a?(c=i.parent().width(),b=i.parent().height()):i.append(h),c<2&&(c=e.width),b<2&&(b=e.height),o.blank=!0,o.canvas=h,o.canvas.width=c,o.canvas.height=b,o.clear(),e.backgroundImage&&(n(u),o.blank=!1),o.brush=new e.brush,o.brush._init(u,e.brushSize,e.brushColor),o.brush.strokeBegin&&o.brush.strokeMove&&o.brush.strokeEnd&&(h.addEventListener("touchstart",function(t){var e=i.offset();t.preventDefault(),t.touches.length>0&&o.brush.strokeBegin(t.touches[0].pageX-e.left,t.touches[0].pageY-e.top)},!1),h.addEventListener("touchmove",function(t){var e=i.offset();t.preventDefault(),t.touches.length>0&&o.brush.active&&o.brush.strokeMove(t.touches[0].pageX-e.left,t.touches[0].pageY-e.top)},!1),h.addEventListener("touchend",function(t){t.preventDefault(),0==t.touches.length&&(o.blank=!o.brush.strokeEnd()&&o.blank)},!1),t(h).bind({mousedown:function(t){var e=i.offset();o.brush.strokeBegin(t.pageX-e.left,t.pageY-e.top)},mousemove:function(t){var e=i.offset();o.brush.active&&o.brush.strokeMove(t.pageX-e.left,t.pageY-e.top)},mouseup:function(t){o.blank=!o.brush.strokeEnd()&&o.blank},mouseout:function(t){o.blank=!o.brush.strokeEnd()&&o.blank}}))};s.prototype={clear:function(){var t=this.canvas.getContext("2d"),n=this.canvas.width,s=this.canvas.height;return t.clearRect(0,0,n,s),t.fillStyle=e.backgroundColor,t.fillRect(0,0,n,s),this.blank=!0,this},save:function(t){var n=e.saveFunction;return"function"==typeof t&&(n=t),this.blank||n(this.canvas.toDataURL(e.saveMimeType)),this},update:function(s,r){var i=!!s.backgroundColor,o=!!s.backgroundImage,a=!!s.width,h=!!s.height,u=!!s.brush;t.extend(e,s);var c=this.canvas.getContext("2d");return u&&(this.brush=new e.brush),this.brush._init(c,e.brushSize,e.brushColor),a&&(this.canvas.width=e.width),h&&(this.canvas.height=e.height),(i||o||a||h||r)&&this.clear(),o&&(n(c),this.blank=!1),this}},t.fn.jqScribble=function(e){return this.each(function(){t.data(this,"jqScribble")||t.data(this,"jqScribble",new s(this,e))})}}(jQuery);